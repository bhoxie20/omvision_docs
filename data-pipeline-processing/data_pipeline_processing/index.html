
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../infrastructure-deployment/infrastructure_deployment/">
      
      
        <link rel="next" href="../../data-models-database/data_models_database/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Data Pipeline & Processing Logic - OMVision Developer Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#3-data-pipeline-processing-logic" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="OMVision Developer Documentation" class="md-header__button md-logo" aria-label="OMVision Developer Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OMVision Developer Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Data Pipeline & Processing Logic
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="OMVision Developer Documentation" class="md-nav__button md-logo" aria-label="OMVision Developer Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    OMVision Developer Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    1. System Overview
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            1. System Overview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-overview/system_overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    2. Infrastructure & Deployment
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            2. Infrastructure & Deployment
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../infrastructure-deployment/infrastructure_deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Infrastructure & Deployment
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    3. Data Pipeline & Processing Logic
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            3. Data Pipeline & Processing Logic
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Data Pipeline & Processing Logic
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Data Pipeline & Processing Logic
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#31-dagster-orchestration" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 Dagster Orchestration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.1 Dagster Orchestration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#311-job-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.1 Job Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#312-sensors-triggers" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.2 Sensors &amp; Triggers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#313-workspace-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.3 Workspace Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#314-run-coordination" class="md-nav__link">
    <span class="md-ellipsis">
      3.1.4 Run Coordination
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#32-data-flow-stages" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 Data Flow Stages
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2 Data Flow Stages">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321-signal-ingestion" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.1 Signal Ingestion
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2.1 Signal Ingestion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#accern-signal-ingestion" class="md-nav__link">
    <span class="md-ellipsis">
      Accern Signal Ingestion
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#email-signal-ingestion" class="md-nav__link">
    <span class="md-ellipsis">
      Email Signal Ingestion
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#direct-search-ingestion-harmonic" class="md-nav__link">
    <span class="md-ellipsis">
      Direct Search Ingestion (Harmonic)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322-entity-extraction" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.2 Entity Extraction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2.2 Entity Extraction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-ner-extraction-process" class="md-nav__link">
    <span class="md-ellipsis">
      The NER Extraction Process
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#323-data-enrichment" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.3 Data Enrichment
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2.3 Data Enrichment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#company-enrichment-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Company Enrichment Workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#people-enrichment-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      People Enrichment Workflow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#324-classification" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.4 Classification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#325-persistence" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.5 Persistence
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2.5 Persistence">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#why-this-workflow-exists" class="md-nav__link">
    <span class="md-ellipsis">
      Why This Workflow Exists
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#persistence-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Persistence Workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-flow-summary" class="md-nav__link">
    <span class="md-ellipsis">
      Data Flow Summary
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#33-job-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 Job Dependencies
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#34-signal-processing-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      3.4 Signal Processing Jobs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.4 Signal Processing Jobs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#341-ingest_signals_from_accern" class="md-nav__link">
    <span class="md-ellipsis">
      3.4.1 ingest_signals_from_accern
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#342-ingest_signals_from_emails" class="md-nav__link">
    <span class="md-ellipsis">
      3.4.2 ingest_signals_from_emails
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#343-signal-sensors" class="md-nav__link">
    <span class="md-ellipsis">
      3.4.3 Signal Sensors
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#35-entity-extraction-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      3.5 Entity Extraction Jobs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.5 Entity Extraction Jobs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#351-ingest_companies_from_signals" class="md-nav__link">
    <span class="md-ellipsis">
      3.5.1 ingest_companies_from_signals
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#352-ingest_people_from_signals" class="md-nav__link">
    <span class="md-ellipsis">
      3.5.2 ingest_people_from_signals
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#353-ingest_companies_from_searches" class="md-nav__link">
    <span class="md-ellipsis">
      3.5.3 ingest_companies_from_searches
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#354-ingest_people_from_searches" class="md-nav__link">
    <span class="md-ellipsis">
      3.5.4 ingest_people_from_searches
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#36-classification-job" class="md-nav__link">
    <span class="md-ellipsis">
      3.6 Classification Job
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#37-data-persistence-jobs" class="md-nav__link">
    <span class="md-ellipsis">
      3.7 Data Persistence Jobs
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.7 Data Persistence Jobs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#371-persist_custom_columns_data" class="md-nav__link">
    <span class="md-ellipsis">
      3.7.1 persist_custom_columns_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#372-upsert_data_sources" class="md-nav__link">
    <span class="md-ellipsis">
      3.7.2 upsert_data_sources
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    4. Data Models & Database
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            4. Data Models & Database
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../data-models-database/data_models_database/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Models & Database
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    5. Machine Learning Components
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            5. Machine Learning Components
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../machine-learning-components/machine_learning_components/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Machine Learning Components
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    6. External Integrations
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            6. External Integrations
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../external-integrations/external_integrations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    External Integrations
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    7. Utility Modules
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            7. Utility Modules
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../utility-modules/utility_modules/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Utility Modules
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    8. Appendices
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            8. Appendices
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../appendices/appendices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Appendices
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="3-data-pipeline-processing-logic">3. Data Pipeline &amp; Processing Logic<a class="headerlink" href="#3-data-pipeline-processing-logic" title="Permanent link">&para;</a></h1>
<p>This section provides a comprehensive explanation of OMVision's data pipeline architecture, describing how raw signals from external sources are transformed into enriched, classified, and persisted company records ready for internal analysis.</p>
<h2 id="31-dagster-orchestration">3.1 Dagster Orchestration<a class="headerlink" href="#31-dagster-orchestration" title="Permanent link">&para;</a></h2>
<p>OMVision employs Dagster as its orchestration framework to manage complex, interdependent data workflows. Dagster provides job scheduling, dependency management, resource allocation, and observability across the entire pipeline.</p>
<h3 id="311-job-configuration">3.1.1 Job Configuration<a class="headerlink" href="#311-job-configuration" title="Permanent link">&para;</a></h3>
<p>All jobs are centrally defined in <code>app/main.py</code> within a <code>Definitions</code> object that serves as the entry point for Dagster's code location. This definition includes:</p>
<p><strong>Core Jobs:</strong></p>
<ul>
<li><code>upsert_data_sources</code>: Initializes or updates source configurations</li>
<li><code>ingest_signals_from_accern</code>: Fetches signals from Accern API channels</li>
<li><code>ingest_signals_from_emails</code>: Processes newsletter emails via Gmail</li>
<li><code>ingest_companies_from_searches</code>: Ingests companies from Harmonic saved searches</li>
<li><code>ingest_companies_from_signals</code>: Extracts and enriches companies from signals</li>
<li><code>ingest_people_from_searches</code>: Ingests people from Harmonic saved searches</li>
<li><code>ingest_people_from_signals</code>: Extracts and enriches people from signals</li>
<li><code>classify_ingested_companies</code>: Applies ML classification to unclassified companies</li>
<li><code>persist_custom_columns_data</code>: Syncs custom column metadata from frontend</li>
</ul>
<p><strong>Resources:</strong></p>
<p>Jobs have access to configurable resources defined in the <code>resources</code> dictionary:</p>
<ul>
<li><code>db</code>: <code>DatabaseResource</code> for PostgreSQL interactions</li>
<li><code>accern</code>: <code>AccernResource</code> for Accern API integration</li>
<li><code>openai</code>: <code>OpenAIResource</code> for NER and context extraction</li>
<li><code>gmail</code>: <code>GmailResource</code> for Gmail API integration</li>
<li><code>google</code>: <code>WebSearchResource</code> for URL discovery</li>
<li><code>harmonic</code>: <code>HarmonicResource</code> for Harmonic API enrichment</li>
<li><code>ml</code>: <code>MLResource</code> for machine learning classification</li>
<li><code>s3_io_manager</code>: S3-based I/O manager for asset materialization</li>
</ul>
<p>Resources are instantiated once per run and injected into ops as needed, following Dagster's dependency injection pattern.</p>
<p><strong>Assets:</strong></p>
<p>The system defines one materialized asset:</p>
<ul>
<li><code>company_filter_list</code>: An auto-materializing asset that fetches company names from Harmonic filter search and watchlist, stored in S3</li>
</ul>
<p>This asset uses an eager auto-materialize policy, ensuring it updates when missing and is available for filtering operations.</p>
<h3 id="312-sensors-triggers">3.1.2 Sensors &amp; Triggers<a class="headerlink" href="#312-sensors-triggers" title="Permanent link">&para;</a></h3>
<p>OMVision uses <strong>run status sensors</strong> to create chained workflows where downstream jobs trigger automatically upon successful completion of upstream jobs. This pattern decouples signal ingestion from entity extraction while maintaining execution order.</p>
<p><strong>Signal Ingestion Sensors:</strong></p>
<p>Defined in <code>app/sensors/main.py</code>, two sensors monitor signal ingestion jobs:</p>
<ol>
<li>
<p><strong><code>signal_ingestion_from_accern</code></strong></p>
</li>
<li>
<p>Monitors: <code>ingest_signals_from_accern</code></p>
</li>
<li>Triggers on: <code>DagsterRunStatus.SUCCESS</code></li>
<li>Requests: <code>ingest_companies_from_signals</code> and <code>ingest_people_from_signals</code></li>
<li>Minimum interval: 7200 seconds (2 hours)</li>
<li>Configuration: Injects source-specific config via <code>get_op_config("Accern")</code></li>
</ol>
<p><strong>Behavior</strong>: When Accern signal ingestion succeeds, the sensor yields two RunRequest objects—one for company extraction configured for the “Accern” source, and one for people extraction. The 2-hour minimum interval prevents rapid re-triggering if multiple Accern jobs complete in succession.</p>
<ol>
<li>
<p><strong><code>signal_ingestion_from_emails</code></strong></p>
</li>
<li>
<p>Monitors: <code>ingest_signals_from_emails</code></p>
</li>
<li>Triggers on: <code>DagsterRunStatus.SUCCESS</code></li>
<li>Requests: <code>ingest_companies_from_signals</code> and <code>ingest_people_from_signals</code></li>
<li>Minimum interval: 7200 seconds (2 hours)</li>
<li>Configuration: Injects source-specific config via <code>get_op_config("Gmail")</code></li>
</ol>
<p><strong>Behavior</strong>: Mirrors the Accern sensor but configured for the “Gmail” data source. When email signal ingestion completes successfully, it triggers parallel company and people extraction jobs</p>
<p>The minimum interval prevents sensor over-triggering in case of rapid successive runs.</p>
<p><strong>Sensor Logic Flow:</strong></p>
<pre class="mermaid"><code>graph TB
    A[ingest_signals_from_accern] --&gt;|SUCCESS| B[signal_ingestion_from_accern sensor]
    B --&gt; C[ingest_companies_from_signals]
    B --&gt; D[ingest_people_from_signals]

    E[ingest_signals_from_emails] --&gt;|SUCCESS| F[signal_ingestion_from_emails sensor]
    F --&gt; G[ingest_companies_from_signals]
    F --&gt; H[ingest_people_from_signals]

    style B fill:#e1f5ff
    style F fill:#e1f5ff</code></pre>
<p><strong>Configuration Injection:</strong></p>
<p>The <code>get_op_config</code> utility (in <code>app/sensors/op_config.py</code>) dynamically constructs run configurations based on source name and pipeline type:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_op_config</span><span class="p">(</span><span class="n">source_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pipeline_type</span><span class="p">:</span> <span class="n">PipelineType</span> <span class="o">=</span> <span class="n">PipelineType</span><span class="o">.</span><span class="n">company</span><span class="p">):</span>
    <span class="n">op_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;fetch_source_from_db&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;source_name&quot;</span><span class="p">:</span> <span class="n">source_name</span><span class="p">},</span>
            <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;source_name&quot;</span><span class="p">:</span> <span class="n">source_name</span><span class="p">},</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">watchlist_config</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;source_name&quot;</span><span class="p">:</span> <span class="n">source_name</span><span class="p">}}</span>

    <span class="k">if</span> <span class="n">pipeline_type</span> <span class="o">==</span> <span class="n">PipelineType</span><span class="o">.</span><span class="n">company</span><span class="p">:</span>
        <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;get_source_watchlist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">watchlist_config</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;get_source_people_watchlist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">watchlist_config</span>

    <span class="k">return</span> <span class="n">op_config</span>
</code></pre></div>
<p>This ensures that downstream jobs process entities associated with the correct source and watchlist.</p>
<h3 id="313-workspace-configuration">3.1.3 Workspace Configuration<a class="headerlink" href="#313-workspace-configuration" title="Permanent link">&para;</a></h3>
<p>The Dagster workspace is configured via <code>workspace.yaml</code>, which defines code locations accessible to the webserver and daemon.</p>
<p><strong>Workspace Definition:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">load_from</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">grpc_server</span><span class="p">:</span>
<span class="w">      </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deal_flow_code</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4000</span>
<span class="w">      </span><span class="nt">location_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;DealFlow&quot;</span>
</code></pre></div>
<p>This configuration tells Dagster to load job definitions from a gRPC server running on the <code>deal_flow_code</code> service at port 4000.</p>
<p><strong>Service Architecture:</strong></p>
<p>The system deploys three Docker services (defined in <code>docker-compose.yaml</code>):</p>
<ol>
<li><strong><code>dagster_webserver</code></strong>: Hosts the Dagster UI on port 3000, loads jobs from gRPC server</li>
<li><strong><code>dagster_daemon</code></strong>: Background service that executes queued runs and manages schedules/sensors</li>
<li><strong><code>deal_flow_code</code></strong>: gRPC server exposing all user-defined jobs, ops, resources, and assets</li>
</ol>
<p><strong>Code Location Server:</strong></p>
<p>The <code>deal_flow_code</code> service runs:
<div class="highlight"><pre><span></span><code>dagster<span class="w"> </span>api<span class="w"> </span>grpc<span class="w"> </span>-h<span class="w"> </span><span class="m">0</span>.0.0.0<span class="w"> </span>-p<span class="w"> </span><span class="m">4000</span><span class="w"> </span>-f<span class="w"> </span>app/main.py
</code></pre></div></p>
<p>This command starts a gRPC server that serializes the <code>Definitions</code> object from <code>app/main.py</code> and serves it to the webserver and daemon. This architecture separates orchestration infrastructure (webserver/daemon) from business logic (user code), enabling independent scaling and deployment.</p>
<p>See §2.1.1 for detailed Docker service configuration.</p>
<h3 id="314-run-coordination">3.1.4 Run Coordination<a class="headerlink" href="#314-run-coordination" title="Permanent link">&para;</a></h3>
<p>OMVision uses the <strong>QueuedRunCoordinator</strong> to manage job execution, defined in <code>dagster-prod.yaml</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">run_coordinator</span><span class="p">:</span>
<span class="w">  </span><span class="nt">module</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dagster.core.run_coordinator</span>
<span class="w">  </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">QueuedRunCoordinator</span>
</code></pre></div>
<p><strong>Execution Flow:</strong></p>
<ol>
<li>When a job is launched (via schedule, sensor, or manual trigger), the webserver creates a run and places it in a queue</li>
<li>The <code>dagster_daemon</code> service polls the queue and dequeues runs for execution</li>
<li>Runs are launched via the <strong>EcsRunLauncher</strong>, which creates ephemeral ECS tasks:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="nt">run_launcher</span><span class="p">:</span>
<span class="w">  </span><span class="nt">module</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dagster_aws.ecs</span>
<span class="w">  </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">EcsRunLauncher</span>
<span class="w">  </span><span class="nt">config</span><span class="p">:</span>
<span class="w">    </span><span class="nt">include_sidecars</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">secrets_tag</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
</code></pre></div>
<p>Each job run executes in an isolated ECS task using the same container image (<code>deal_flow_code</code>). This provides:</p>
<ul>
<li><strong>Isolation</strong>: Failures in one run don't affect others</li>
<li><strong>Scalability</strong>: Multiple runs can execute concurrently across ECS cluster</li>
<li><strong>Resource control</strong>: ECS enforces CPU/memory limits per run</li>
</ul>
<p><strong>Schedules:</strong></p>
<p>Jobs are scheduled via cron expressions defined in <code>app/schedules/main.py</code>:</p>
<table>
<thead>
<tr>
<th>Schedule</th>
<th>Job</th>
<th>Cron</th>
<th>Execution Time</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>accern_ingest</code></td>
<td><code>ingest_signals_from_accern</code></td>
<td><code>0 15 * * *</code></td>
<td>Daily at 3:00 PM UTC</td>
</tr>
<tr>
<td><code>emails_ingest</code></td>
<td><code>ingest_signals_from_emails</code></td>
<td><code>0 15 * * *</code></td>
<td>Daily at 3:00 PM UTC</td>
</tr>
<tr>
<td><code>harmonic_ingest</code></td>
<td><code>ingest_companies_from_searches</code></td>
<td><code>0 15 * * *</code></td>
<td>Daily at 3:00 PM UTC</td>
</tr>
<tr>
<td><code>harmonic_people_ingest</code></td>
<td><code>ingest_people_from_searches</code></td>
<td><code>0 15 * * *</code></td>
<td>Daily at 3:00 PM UTC</td>
</tr>
<tr>
<td><code>data_persistor</code></td>
<td><code>persist_custom_columns_data</code></td>
<td><code>0 18 * * *</code></td>
<td>Daily at 6:00 PM UTC</td>
</tr>
<tr>
<td><code>company_classifier</code></td>
<td><code>classify_ingested_companies</code></td>
<td><code>30 18 * * *</code></td>
<td>Daily at 6:30 PM UTC</td>
</tr>
</tbody>
</table>
<p><strong>Execution Sequence:</strong></p>
<p>The schedule timing ensures proper sequencing:</p>
<ul>
<li>Signal ingestion and direct searches execute at 3:00 PM</li>
<li>Sensors trigger entity extraction jobs upon successful ingestion (3:00-5:00 PM)</li>
<li>Custom column persistence runs at 6:00 PM (after entity processing)</li>
<li>Classification runs at 6:30 PM (after new companies are stored)</li>
</ul>
<p><strong>Storage Configuration:</strong></p>
<p>All orchestration metadata (run history, logs, schedules) is stored in PostgreSQL:</p>
<div class="highlight"><pre><span></span><code><span class="nt">run_storage</span><span class="p">:</span>
<span class="w">  </span><span class="nt">module</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dagster_postgres.run_storage</span>
<span class="w">  </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PostgresRunStorage</span>

<span class="nt">event_log_storage</span><span class="p">:</span>
<span class="w">  </span><span class="nt">module</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dagster_postgres.event_log</span>
<span class="w">  </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PostgresEventLogStorage</span>

<span class="nt">schedule_storage</span><span class="p">:</span>
<span class="w">  </span><span class="nt">module</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dagster_postgres.schedule_storage</span>
<span class="w">  </span><span class="nt">class</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PostgresScheduleStorage</span>
</code></pre></div>
<p>This centralized storage enables the webserver to display run history and logs while the daemon manages execution state.</p>
<hr />
<h2 id="32-data-flow-stages">3.2 Data Flow Stages<a class="headerlink" href="#32-data-flow-stages" title="Permanent link">&para;</a></h2>
<p>This section documents the five sequential stages through which data flows in OMVision, transforming raw external signals into fully enriched, classified, and stored entities ready for analysis. Each stage builds upon the previous one, progressively refining data quality and adding business intelligence.</p>
<pre class="mermaid"><code>graph LR
    A[Signal Ingestion] --&gt; B[Entity Extraction]
    B --&gt; C[Data Enrichment]
    C --&gt; D[Classification]
    D --&gt; E[Persistence]

    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1f5
    style D fill:#f5e1ff
    style E fill:#e1ffe1</code></pre>
<p>The pipeline processes three distinct data sources:</p>
<ul>
<li><strong>Accern</strong>: News articles and funding events with structured entity/event fields</li>
<li><strong>Gmail</strong>: Newsletter emails containing company announcements</li>
<li><strong>Harmonic Search</strong>: Pre-qualified companies from saved searches</li>
</ul>
<hr />
<h3 id="321-signal-ingestion">3.2.1 Signal Ingestion<a class="headerlink" href="#321-signal-ingestion" title="Permanent link">&para;</a></h3>
<p>Signal ingestion is the entry point for all external data. Signals represent raw, unprocessed records from data sources that potentially mention early-stage companies or founders. Each of the three signal types has its own ingestion pathway optimized for its unique data structure and availability.</p>
<h4 id="accern-signal-ingestion">Accern Signal Ingestion<a class="headerlink" href="#accern-signal-ingestion" title="Permanent link">&para;</a></h4>
<p><strong>Datasource Overview</strong></p>
<p>Accern is a portfolio company of OMVC that uses NLP and ML to identify relevant signals across wide data sets, capturing hidden trends in venture funding, partnerships, and company developments. Accern delivers data through use-case-specific channels, each representing a distinct topical feed (e.g., "real-time venture deal flow" or "co-investor tracking").</p>
<p>OMVision maintains three active Accern channels, each with a dedicated API endpoint and authentication token. Channel configuration is stored in <code>app/constants/data_sources.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">Channel</span><span class="p">(</span>
    <span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span><span class="p">,</span>
    <span class="n">api_endpoint</span><span class="o">=</span><span class="s2">&quot;feed/real-time-venture-deal-flow-bcc2d312-vectr&quot;</span>
<span class="p">),</span>
<span class="n">Channel</span><span class="p">(</span>
    <span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span><span class="p">,</span>
    <span class="n">api_endpoint</span><span class="o">=</span><span class="s2">&quot;feed/deal-flow-fund-i-co-investor-tracking-6706ac78-vectr&quot;</span>
<span class="p">),</span>
<span class="n">Channel</span><span class="p">(</span>
    <span class="n">api_key</span><span class="o">=</span><span class="s2">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span><span class="p">,</span>
    <span class="n">api_endpoint</span><span class="o">=</span><span class="s2">&quot;feed/deal-flow-fund-ii-co-investor-tracking-e1c5e74b-vectr&quot;</span>
<span class="p">)</span>
</code></pre></div>
<p><strong>Ingestion Process</strong></p>
<p>The <code>ingest_signals_from_accern</code> job (in <code>app/jobs/ingest_signals_from_accern.py</code>) orchestrates the following workflow:</p>
<p><strong>1. Fetch Source Metadata</strong> (<code>fetch_source_from_db</code>)</p>
<p>Retrieves the "Accern" data source record from the database, including all associated channels with their API credentials. The source metadata links ingested signals to their originating source for traceability.</p>
<p><strong>2. Ingest Data from Channels</strong> (<code>ingest_data_from_channels</code>)</p>
<p>For each configured channel, the <code>AccernResource</code> (<code>app/resources/accern_api.py</code>) fetches the last 24 hours of signals:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fetch_feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AccernFeed</span><span class="p">:</span>
    <span class="n">ny_tz</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s2">&quot;America/New_York&quot;</span><span class="p">)</span>
    <span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">ny_tz</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="n">end_date</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

    <span class="n">endpoint_with_queries</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">?token=</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&amp;published_at=[</span><span class="si">{</span><span class="n">start_str</span><span class="si">}</span><span class="s2">..</span><span class="si">{</span><span class="n">end_str</span><span class="si">}</span><span class="s2">]&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">endpoint_with_queries</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;user-agent&quot;</span><span class="p">:</span> <span class="s2">&quot;dagster&quot;</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">AccernFeed</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</code></pre></div>
<p>The API returns an <code>AccernFeed</code> object containing metadata about the time window and a list of <code>AccernSignal</code> objects.</p>
<p><strong>3. Extract Signals from Feeds</strong> (<code>get_signals_from_feeds</code>)</p>
<p>Aggregates signals from all channel feeds into a single list. Accern signals contain structured fields that facilitate downstream NER extraction:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AccernSignal</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">entity_text</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>        <span class="c1"># Text snippets describing entities</span>
    <span class="n">event_text</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>          <span class="c1"># Text snippets describing events</span>
    <span class="n">entity_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>     <span class="c1"># Primary entity mentioned</span>
    <span class="n">entity_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>     <span class="c1"># Entity classification (Company, Person, etc.)</span>
    <span class="n">doc_title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>       <span class="c1"># Article/document title</span>
    <span class="n">doc_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>         <span class="c1"># Source URL</span>
    <span class="n">doc_sentiment</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
    <span class="n">event</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>           <span class="c1"># Event classification (Funding, Acquisition, etc.)</span>
    <span class="n">published_at</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span>
    <span class="c1"># ... additional metadata fields</span>
</code></pre></div>
<p><strong>4. Deduplicate Signal Context</strong> (<code>get_unique_context_from_signals</code>)</p>
<p>Accern may deliver duplicate signals across channels or within the 24-hour window. Deduplication keys on a composite of:
- <code>entity_text</code> (tuple)
- <code>event_text</code> (tuple)
- <code>entity_name</code>
- <code>entity_type</code>
- <code>doc_title</code>
- <code>doc_url</code></p>
<p><strong>Implementation</strong> (<code>app/jobs/ingest_signals_from_accern.py</code>):</p>
<div class="highlight"><pre><span></span><code><span class="nd">@op</span><span class="p">(</span><span class="n">out</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;unique_contexts&quot;</span><span class="p">:</span> <span class="n">Out</span><span class="p">(),</span> <span class="s2">&quot;unique_signals&quot;</span><span class="p">:</span> <span class="n">Out</span><span class="p">()})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_unique_context_from_signals</span><span class="p">(</span>
    <span class="n">context</span><span class="p">,</span> <span class="n">signals</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">AccernSignal</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">AccernSignal</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts context from each signal, focusing on entity and event text, as well as </span>
<span class="sd">    additional metadata. Ensures that the list of signal contexts returned is unique </span>
<span class="sd">    and also returns the corresponding unique signals.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unique_contexts</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">signal</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
        <span class="c1"># Create composite key from all signal fields</span>
        <span class="n">context_key</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">entity_text</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">entity_text</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">signal</span><span class="o">.</span><span class="n">entity_text</span>
            <span class="p">),</span>
            <span class="p">(</span>
                <span class="nb">tuple</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">event_text</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">event_text</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">signal</span><span class="o">.</span><span class="n">event_text</span>
            <span class="p">),</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">entity_name</span><span class="p">,</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">entity_type</span><span class="p">,</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">doc_title</span><span class="p">,</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">doc_url</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Store only first occurrence of each unique context</span>
        <span class="k">if</span> <span class="n">context_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_contexts</span><span class="p">:</span>
            <span class="n">unique_contexts</span><span class="p">[</span><span class="n">context_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">signal</span>

    <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unique Accern signals retrieved: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_contexts</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">unique_signals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique_contexts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># Convert tuple keys back to dictionary format for downstream processing</span>
    <span class="n">unique_signal_contexts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;entity_text&quot;</span><span class="p">:</span> <span class="n">context_key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;event_text&quot;</span><span class="p">:</span> <span class="n">context_key</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;entity_name&quot;</span><span class="p">:</span> <span class="n">context_key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;entity_type&quot;</span><span class="p">:</span> <span class="n">context_key</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="s2">&quot;doc_title&quot;</span><span class="p">:</span> <span class="n">context_key</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
            <span class="s2">&quot;doc_url&quot;</span><span class="p">:</span> <span class="n">context_key</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">context_key</span> <span class="ow">in</span> <span class="n">unique_contexts</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">unique_signal_contexts</span><span class="p">,</span> <span class="n">unique_signals</span>
</code></pre></div>
<p>Only the first occurrence of each unique context is retained, reducing redundant processing downstream. The operation returns both the unique signal contexts (dictionaries containing the deduplicated fields) and the corresponding unique <code>AccernSignal</code> objects.</p>
<p><strong>Why deduplication matters</strong>: Without this step, the pipeline would extract entities from the same article multiple times, inflating storage costs and creating duplicate company records. Deduplication at this stage (before expensive OpenAI calls) minimizes API usage and database writes.</p>
<hr />
<p><strong>At this point, the pipeline has unique signal contexts ready for entity extraction. The next stage involves OpenAI-based NER.</strong></p>
<hr />
<h4 id="email-signal-ingestion">Email Signal Ingestion<a class="headerlink" href="#email-signal-ingestion" title="Permanent link">&para;</a></h4>
<p><strong>Datasource Overview</strong></p>
<p>OMVision monitors a dedicated Gmail inbox (<code>newsletters@omvc.co</code>) subscribed to venture capital newsletters, founder announcements, and industry publications. These newsletters frequently mention early-stage companies, funding rounds, product launches, and team expansions—all valuable dealflow signals.</p>
<p><strong>Ingestion Process</strong></p>
<p>The <code>ingest_signals_from_emails</code> job (in <code>app/jobs/ingest_signals_from_emails.py</code>) follows a simplified workflow compared to Accern, as emails lack the structured entity/event separation:</p>
<p><strong>1. Fetch Source Metadata</strong> (<code>fetch_source_from_db</code>)</p>
<p>Retrieves the "Gmail" data source record, which does not have channels (unlike Accern) but is linked to a single service account.</p>
<p><strong>2. Fetch Emails</strong> (<code>fetch_emails</code>)</p>
<p>The <code>GmailResource</code> (configured with a service account JSON key) retrieves all emails from the past 24 hours using the Gmail API:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_emails</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">MailMessage</span><span class="p">]:</span>
    <span class="c1"># Authenticates with service account</span>
    <span class="c1"># Queries messages from last 24 hours</span>
    <span class="c1"># Returns list of MailMessage objects with body, subject, sender, date</span>
</code></pre></div>
<p>Each <code>MailMessage</code> contains the email body (HTML or plaintext) and metadata.</p>
<p><strong>3. Extract Email Context</strong> (<code>get_context_from_emails</code>)</p>
<p>Email bodies are extracted as strings. Unlike Accern signals with pre-separated <code>entity_text</code> and <code>event_text</code>, email content is unstructured prose. This operation serves as a critical data extraction layer that transforms structured email objects into plain text for NER processing.</p>
<p><strong>Implementation</strong> (<code>app/jobs/ingest_signals_from_emails.py</code>):</p>
<div class="highlight"><pre><span></span><code><span class="nd">@op</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_context_from_emails</span><span class="p">(</span><span class="n">emails</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">MailMessage</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts the body content from each email message.</span>

<span class="sd">    Args:</span>
<span class="sd">        emails (list[MailMessage]): A list of email messages.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[str]: A list of email body content as strings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">email</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">emails</span><span class="p">]</span>
</code></pre></div>
<p><strong>Why This Formatting is Needed</strong>:</p>
<p>This seemingly simple operation serves several critical architectural purposes:</p>
<p><strong>1. Type Transformation</strong></p>
<p>Converts from structured <code>MailMessage</code> objects to simple strings:</p>
<p><em>Input type:</em> <code>MailMessage</code> (Pydantic model)
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MailMessage</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">sender</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>  <span class="c1"># &quot;techcrunch@newsletter.com&quot;</span>
    <span class="n">date</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>    <span class="c1"># &quot;2025-11-04&quot;</span>
    <span class="n">body</span><span class="p">:</span> <span class="nb">str</span>              <span class="c1"># Full email text content</span>
</code></pre></div></p>
<p><em>Output type:</em> <code>list[str]</code> (plain text strings)</p>
<p><strong>2. Data Abstraction &amp; Pipeline Consistency</strong></p>
<p>Creates a uniform interface for downstream NER operations:</p>
<ul>
<li><strong>Isolates relevant data</strong>: Extracts body text from metadata (sender, date)</li>
<li><strong>Enables source-agnostic processing</strong>: The NER pipeline (<code>get_entities_from_emails</code>, <code>extract_entity_context_from_emails</code>) works with strings regardless of whether they originated from emails, Accern signals, or other sources</li>
<li><strong>Single responsibility</strong>: Each pipeline stage has a clear, bounded function</li>
</ul>
<p><strong>3. Format Transformation</strong></p>
<p><em>Before <code>get_context_from_emails</code>:</em>
<div class="highlight"><pre><span></span><code><span class="p">[</span>
    <span class="n">MailMessage</span><span class="p">(</span>
        <span class="n">sender</span><span class="o">=</span><span class="s2">&quot;techcrunch@newsletter.com&quot;</span><span class="p">,</span>
        <span class="n">date</span><span class="o">=</span><span class="s2">&quot;2025-11-04&quot;</span><span class="p">,</span>
        <span class="n">body</span><span class="o">=</span><span class="s2">&quot;DeepTech raises $10M for healthcare AI diagnostic imaging. The Series A round...&quot;</span>
    <span class="p">),</span>
    <span class="n">MailMessage</span><span class="p">(</span>
        <span class="n">sender</span><span class="o">=</span><span class="s2">&quot;venturehacks@newsletter.com&quot;</span><span class="p">,</span> 
        <span class="n">date</span><span class="o">=</span><span class="s2">&quot;2025-11-04&quot;</span><span class="p">,</span>
        <span class="n">body</span><span class="o">=</span><span class="s2">&quot;Series A spotlight: Five robotics startups to watch including RoboTech...&quot;</span>
    <span class="p">)</span>
<span class="p">]</span>
</code></pre></div></p>
<p><em>After <code>get_context_from_emails</code>:</em>
<div class="highlight"><pre><span></span><code><span class="p">[</span>
    <span class="s2">&quot;DeepTech raises $10M for healthcare AI diagnostic imaging. The Series A round...&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Series A spotlight: Five robotics startups to watch including RoboTech...&quot;</span>
<span class="p">]</span>
</code></pre></div></p>
<p><strong>4. Metadata Preservation</strong></p>
<p>While the body text is extracted for NER, the original <code>MailMessage</code> objects are preserved throughout the pipeline and later used in <code>combine_emails_and_entities</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">processed_signals</span> <span class="o">=</span> <span class="n">combine_emails_and_entities</span><span class="p">(</span>
    <span class="n">source_data</span><span class="p">,</span> 
    <span class="n">ingested_emails</span><span class="p">,</span>      <span class="c1"># ← Original MailMessage objects with full metadata</span>
    <span class="n">filtered_entities</span><span class="p">,</span>    <span class="c1"># ← Extracted entities from body text</span>
    <span class="n">raw_entities</span>
<span class="p">)</span>
</code></pre></div>
<p>This allows the full email metadata (sender, date) to be stored in the database's <code>source_data</code> field for audit and traceability purposes, while the NER pipeline operates only on the relevant text content.</p>
<p><strong>5. Simplified Downstream Logic</strong></p>
<p>By converting to strings early, all downstream operations can use the same code paths:</p>
<div class="highlight"><pre><span></span><code><span class="c1">## Email pipeline (after get_context_from_emails)</span>
<span class="k">for</span> <span class="n">email_body</span> <span class="ow">in</span> <span class="n">email_body_list</span><span class="p">:</span>  <span class="c1"># Processes simple strings</span>
    <span class="n">preprocessed_text</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">preprocess_text</span><span class="p">(</span><span class="n">email_body</span><span class="p">)</span>
    <span class="n">extracted_entities</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">get_all_ner_tags</span><span class="p">(</span><span class="n">preprocessed_text</span><span class="p">,</span> <span class="n">vanilla_prompt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<p>Compare to Accern (which also produces strings after combining entity_text + event_text):
<div class="highlight"><pre><span></span><code><span class="c1">## Accern pipeline (after combining fields)</span>
<span class="k">for</span> <span class="n">signal</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
    <span class="n">combined_text</span> <span class="o">=</span> <span class="n">entity_text</span> <span class="o">+</span> <span class="n">event_text</span>  <span class="c1"># Also produces strings</span>
    <span class="n">preprocessed_text</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">preprocess_text</span><span class="p">(</span><span class="n">combined_text</span><span class="p">)</span>
    <span class="n">extracted_entities</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">get_all_ner_tags</span><span class="p">(</span><span class="n">preprocessed_text</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">vanilla_prompt</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></p>
<p>Both pipelines converge on string processing, despite starting with different data structures.</p>
<p><strong>6. Reusability</strong></p>
<p>The extracted string list is reused for entity context extraction without re-parsing the email objects:</p>
<div class="highlight"><pre><span></span><code><span class="n">signal_contexts</span> <span class="o">=</span> <span class="n">extract_entity_context_from_emails</span><span class="p">(</span>
    <span class="n">email_context</span><span class="p">,</span>        <span class="c1"># ← Same list[str] from get_context_from_emails</span>
    <span class="n">relevant_entities</span>
<span class="p">)</span>
</code></pre></div>
<p><strong>Underlying Data Cleaning</strong></p>
<p>The actual text cleaning happens earlier in <code>GmailResource.get_emails()</code> (<code>app/resources/mail_client.py</code>):</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_clean_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cleans an email message by removing CSS and extracting plain text content.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">message_no_css</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\*{.*?}}\r\n&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">message_no_css</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
        <span class="n">clean_text</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">separator</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">clean_text</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">message</span>
</code></pre></div>
<p>This method:</p>
<ul>
<li>Strips CSS styles (regex removes <code>*{...}</code> blocks)</li>
<li>Parses HTML with BeautifulSoup and extracts plain text</li>
<li>Removes formatting artifacts and normalizes whitespace</li>
</ul>
<p>By the time <code>get_context_from_emails</code> executes, email bodies are already clean plain text—the operation simply extracts them from the <code>MailMessage</code> objects.</p>
<p><strong>What is sent to NER</strong>: The entire email body text as a plain string. Preprocessing (§3.2.2) will filter this unstructured content before entity extraction.</p>
<p><strong>Architectural Benefits</strong></p>
<p>This design pattern exemplifies good software engineering:</p>
<ul>
<li><strong>Separation of concerns</strong>: Email fetching, text extraction, and NER are distinct stages</li>
<li><strong>Interface segregation</strong>: Downstream operations receive only the data they need (text), not extraneous metadata</li>
<li><strong>Reusability</strong>: The same NER code processes emails and Accern signals despite different source structures</li>
<li><strong>Auditability</strong>: Original metadata is preserved separately for database storage</li>
</ul>
<p><strong>Why no deduplication</strong>: Email ingestion does not deduplicate because each email, even if covering the same company, represents a distinct temporal signal. Multiple newsletters mentioning the same funding round on the same day provide reinforcing evidence of relevance.</p>
<hr />
<h4 id="direct-search-ingestion-harmonic">Direct Search Ingestion (Harmonic)<a class="headerlink" href="#direct-search-ingestion-harmonic" title="Permanent link">&para;</a></h4>
<p><strong>Datasource Overview</strong></p>
<p>Harmonic is a B2B company intelligence platform that provides structured company and people data. Unlike Accern and Gmail, which require NER to discover entities, Harmonic searches return fully identified and enriched entities directly.</p>
<p>OMVision leverages Harmonic's saved search functionality: investment team members create searches in Harmonic's UI with specific criteria (e.g., "Series A companies in healthcare AI with 10-50 employees"), and OMVision automatically ingests net-new results daily.</p>
<p><strong>Company Ingestion</strong></p>
<p>The <code>ingest_companies_from_searches</code> job (<code>app/jobs/ingest_companies_from_searches.py</code>) processes companies from saved searches. This pathway bypasses NER entirely because entities are already identified:</p>
<p><strong>1. Fetch Source Metadata</strong> (<code>fetch_source_from_db</code>)</p>
<p>Retrieves the "Harmonic Search" data source, which contains the Harmonic API key in its channel configuration.</p>
<p><strong>2. Fetch Saved Searches</strong> (<code>fetch_all_searches</code>, <code>get_saved_searches_from_harmonic</code>)</p>
<p>The <code>HarmonicResource</code> calls <code>harmonic.get_saved_searches(type=SearchType.companies)</code>, which:</p>
<ul>
<li>Makes a GET request to <code>https://api.harmonic.ai/savedSearches</code></li>
<li>Filters searches where <code>name</code> starts with "DealFlow" (excluding "DealFlow - Filter list")</li>
<li>Returns a list of <code>SearchList</code> objects with search name and URN</li>
</ul>
<p>This naming convention allows team members to designate which searches OMVision should monitor.</p>
<p><strong>3. Fetch Companies for Each Search</strong> (<code>fetch_all_companies_by_search</code>, <code>get_companies_from_search</code>)</p>
<p>For each saved search, the system retrieves associated companies:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_companies_by_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">CompanyBase</span><span class="p">]:</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_all_pages</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;savedSearches:results/</span><span class="si">{</span><span class="n">search_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">CompanyBase</span><span class="p">)</span>
</code></pre></div>
<p>The <code>_fetch_all_pages</code> method handles pagination, iterating through result pages until <code>page_info["has_next"]</code> is False. Each company is returned as a fully populated <code>CompanyBase</code> object with:</p>
<ul>
<li>Company name, description, website</li>
<li>Founding date, location, ownership status</li>
<li>Funding details, stage, headcount</li>
<li>People (employees), highlights, socials</li>
<li>All available Harmonic metrics</li>
</ul>
<p><strong>4. Parse Company Metadata</strong> (<code>parse_incoming_data</code>)</p>
<p>Extracts three parallel structures from the search results:</p>
<ul>
<li><strong>Company URNs</strong>: Unique resource names for Harmonic's internal identification (format: <code>urn:harmonic:company:...</code>)</li>
<li><strong><code>SearchWithCompanyIds</code></strong>: Maps each search name to a list of company IDs (Harmonic's integer identifiers)</li>
<li><strong><code>CompanyBase</code> objects</strong>: Full company data for storage</li>
</ul>
<p><strong>5. Store Search Metadata</strong> (<code>store_harmonic_search_in_db</code>)</p>
<p>Creates <code>Search</code> records in the database, linking each search to the Harmonic source and storing <code>source_company_ids</code> to track which companies originated from which search. This traceability enables analysis of search effectiveness.</p>
<p><strong>6. Store Companies and Metrics</strong> (<code>store_harmonic_companies_in_db</code>, <code>store_company_metrics_in_db</code>)</p>
<p>Companies are stored in two related tables:</p>
<ul>
<li><strong><code>Company</code></strong>: Core attributes (name, description, website, location, tags, etc.)</li>
<li><strong><code>CompanyMetric</code></strong>: Time-series and quantitative data (funding, headcount, traction metrics, employee highlights)</li>
</ul>
<p>Each <code>Company</code> record links to its originating <code>Search</code> via <code>search_id</code>, and each <code>CompanyMetric</code> links to its <code>Company</code> via <code>company_id</code>.</p>
<p><strong>7. Add to Watchlist</strong> (<code>add_to_harmonic_watchlist</code>)</p>
<p>Company URNs are bulk-added to the source-specific Harmonic watchlist ("DealFlow - Harmonic Search"):</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_company_to_watchlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">watchlist_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">company_urns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;urns&quot;</span><span class="p">:</span> <span class="n">company_urns</span><span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span><span class="si">}</span><span class="s2">watchlists/companies/</span><span class="si">{</span><span class="n">watchlist_id</span><span class="si">}</span><span class="s2">:addCompanies&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>
    <span class="p">)</span>
</code></pre></div>
<p>This enables ongoing monitoring within Harmonic's platform, ensuring OMVision's tracked companies remain visible to the investment team in Harmonic.</p>
<hr />
<p><strong>People Ingestion</strong></p>
<p>The <code>ingest_people_from_searches</code> job mirrors the company flow but processes people entities:</p>
<ul>
<li>Fetches saved searches with <code>type=SearchType.people</code></li>
<li>Retrieves people via <code>get_people_by_search(search_id)</code></li>
<li>Stores <code>Person</code> records with LinkedIn URL, experience, education, highlights</li>
<li>Adds people URNs to the people watchlist via <code>add_people_to_watchlist</code></li>
</ul>
<hr />
<h3 id="322-entity-extraction">3.2.2 Entity Extraction<a class="headerlink" href="#322-entity-extraction" title="Permanent link">&para;</a></h3>
<p>Entity extraction transforms unstructured signal text into structured lists of companies and people. This stage is critical for Accern and Gmail signals, which contain entity mentions embedded in prose. Harmonic signals skip this stage entirely as entities are pre-identified.</p>
<p>OMVision employs a multi-step NER pipeline powered by OpenAI's GPT models, combining text preprocessing, chunking, structured entity extraction, LLM-based filtering, and context extraction for URL discovery.</p>
<h4 id="the-ner-extraction-process">The NER Extraction Process<a class="headerlink" href="#the-ner-extraction-process" title="Permanent link">&para;</a></h4>
<p><strong>1. Preprocess Text</strong></p>
<p>Before entity extraction, signal text undergoes LLM-based preprocessing to remove irrelevant content and improve extraction accuracy.</p>
<p><strong>Accern Preprocessing</strong></p>
<p>Accern signals have structured <code>entity_text</code> and <code>event_text</code> fields. The <code>get_entities_from_signals</code> op in <code>app/jobs/ingest_signals_from_accern.py</code> combines these fields:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">signal</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
    <span class="n">entity_text</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entity_text&quot;</span><span class="p">,</span> <span class="p">[])</span>  <span class="c1"># List of strings</span>
    <span class="n">event_text</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;event_text&quot;</span><span class="p">,</span> <span class="p">[])</span>    <span class="c1"># List of strings</span>

    <span class="c1"># Ensure both are lists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity_text</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">entity_text</span> <span class="o">=</span> <span class="p">[</span><span class="n">entity_text</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event_text</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">event_text</span> <span class="o">=</span> <span class="p">[</span><span class="n">event_text</span><span class="p">]</span>

    <span class="c1"># Combine into single list</span>
    <span class="n">combined_text</span> <span class="o">=</span> <span class="n">entity_text</span> <span class="o">+</span> <span class="n">event_text</span>

    <span class="c1"># Preprocess with OpenAI</span>
    <span class="n">preprocessed_text</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">preprocess_text</span><span class="p">(</span><span class="n">combined_text</span><span class="p">)</span>
</code></pre></div>
<p>The <code>preprocess_text</code> method (<code>app/resources/open_ai.py</code>) sends the combined list to <code>gpt-4o-mini</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">preprocess_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span>
        <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_text_system_prompt</span><span class="p">()},</span>
            <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;```</span><span class="se">\n</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="se">\n</span><span class="s2">```&quot;</span><span class="p">}</span>
        <span class="p">],</span>
        <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</code></pre></div>
<p><strong>Preprocessing Prompt</strong>:</p>
<div class="highlight"><pre><span></span><code>You are a text filtering AI assistant. Your task is to filter incoming text about companies 
and their details delimited by backticks (```), keeping only the relevant information based 
on a provided list of labels. The filtered text will be passed to an extraction function, 
so it&#39;s crucial to remove irrelevant information while preserving the important details.

Here is the list of labels to use for filtering:
person (people, investors, entrepreneurs, etc.), org (organizations, companies, startups, 
agencies, institutions, etc.), gpe (geopolitical entities like countries, cities, states, etc.)

Follow these steps to filter the text:
1. Read the input text carefully.
2. Identify information that relates to the labels provided.
3. Preserve the original wording and order of the relevant information. the filtered text 
   should be a natural language string.
4. Do not add any introductory phrases or summaries to the filtered text.
5. Ensure that the filtered text is coherent and maintains context where necessary.
6. If you are unsure of the usability of the information, you must include it in the 
   filtered text.
7. do not delimit the output filtered text
</code></pre></div>
<p><strong>Example</strong>:</p>
<p><em>Input</em>:
<div class="highlight"><pre><span></span><code>[&quot;DeepTech, a healthcare AI startup focusing on diagnostic imaging, raised $10M in Series A&quot;, 
&quot;The funding round was led by Accel. They compete with Microsoft Azure in the cloud space.&quot;]
</code></pre></div></p>
<p><em>Output</em>:
<div class="highlight"><pre><span></span><code>DeepTech, a healthcare AI startup focusing on diagnostic imaging, raised $10M in Series A. 
The funding round was led by Accel.
</code></pre></div></p>
<p><strong>What was filtered</strong>: The sentence about Microsoft Azure competition was removed as tangential—Microsoft is mentioned as a competitor, not as a primary entity of interest.</p>
<p><strong>Why preprocess</strong>: Preprocessing reduces noise, lowers token costs for subsequent OpenAI calls, and improves NER accuracy by focusing the model on entity-relevant content. The prompt is conservative (instruction #6: "If you are unsure...include it") to avoid over-filtering.</p>
<hr />
<p><strong>Email Preprocessing</strong></p>
<p>Email signals follow a similar but simpler flow in <code>app/jobs/ingest_signals_from_emails.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">email_body</span> <span class="ow">in</span> <span class="n">email_body_list</span><span class="p">:</span>
    <span class="c1"># Email body is already a single string</span>
    <span class="n">preprocessed_text</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">preprocess_text</span><span class="p">(</span><span class="n">email_body</span><span class="p">)</span>
</code></pre></div>
<p>No field combination is needed. The entire email body (already a string) is preprocessed with the same prompt.</p>
<hr />
<p><strong>2. Extract NER Tags</strong></p>
<p>After preprocessing, the text is passed to OpenAI for structured entity extraction. This is where Accern and Email pipelines diverge in complexity.</p>
<p><strong>Accern NER Extraction</strong> (<code>get_all_ner_tags</code> with <code>vanilla_prompt=False</code>)</p>
<p>The <code>get_entities_from_signals</code> op passes both the preprocessed text and the original signal metadata to OpenAI:</p>
<div class="highlight"><pre><span></span><code><span class="n">extracted_entities</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">get_all_ner_tags</span><span class="p">(</span>
    <span class="n">preprocessed_text</span><span class="p">,</span>           <span class="c1"># Filtered text from preprocessing</span>
    <span class="n">signal</span><span class="p">,</span>                      <span class="c1"># Original signal dict with metadata</span>
    <span class="n">vanilla_prompt</span><span class="o">=</span><span class="kc">False</span>         <span class="c1"># Use metadata-enriched prompt</span>
<span class="p">)</span>
</code></pre></div>
<p><strong>Why pass signal metadata?</strong> Accern signals contain contextual hints that improve extraction accuracy:</p>
<ul>
<li><code>doc_title</code>: Article headline provides topical context</li>
<li><code>doc_url</code>: Source domain indicates credibility</li>
<li><code>entity_name</code>: Primary entity mentioned (disambiguation)</li>
<li><code>entity_type</code>: Entity classification hint (Company, Person, etc.)</li>
</ul>
<p>Inside <code>get_all_ner_tags</code> (<code>app/resources/open_ai.py</code>):</p>
<p><strong>Step 2a: Chunk the Preprocessed Text</strong></p>
<p>Long texts are split into overlapping chunks to respect OpenAI's context window:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_get_chunks_from_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">overlap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">disallowed_special</span><span class="o">=</span><span class="p">())</span>
    <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">1200</span>  <span class="c1"># tokens</span>
    <span class="n">token_chunks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">),</span> <span class="n">chunk_size</span> <span class="o">-</span> <span class="n">overlap</span><span class="p">):</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span>
        <span class="n">token_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">token_chunks</span>
</code></pre></div>
<p><strong>Chunking parameters</strong>:</p>
<ul>
<li><strong>Maximum chunk size</strong>: 1200 tokens</li>
<li><strong>Overlap</strong>: 50 tokens between consecutive chunks</li>
<li><strong>Purpose</strong>: Prevent entities spanning chunk boundaries from being missed</li>
</ul>
<p><strong>Example</strong>:
<div class="highlight"><pre><span></span><code>Full text: 1500 tokens
→ Chunk 1: tokens 0-1200 (1200 tokens)
→ Chunk 2: tokens 1150-1500 (350 tokens)
         ↑ 50-token overlap with Chunk 1
</code></pre></div></p>
<p><strong>Step 2b: Extract Entities from Each Chunk</strong></p>
<p>For each chunk, three messages are sent to <code>gpt-4o-2024-08-06</code>:</p>
<p><strong>Message 1: System Message</strong> (role definition)
<div class="highlight"><pre><span></span><code>You are an expert in Natural Language Processing. Your task is to identify common Named 
Entities (NER) in a given natural language signal text. The possible common Named Entities 
(NER) types are exclusively: (person (people, investors, entrepreneurs, etc.), org 
(organizations, companies, startups, agencies, institutions, etc.), gpe (geopolitical 
entities like countries, cities, states, etc.)).
</code></pre></div></p>
<p><strong>Message 2: Assistant Example</strong> (one-shot learning)
<div class="highlight"><pre><span></span><code>EXAMPLE:
    Text: &#39;In Germany, in 1440, goldsmith Johannes Gutenberg invented the movable-type 
    printing press. His work led to an information revolution and the unprecedented 
    mass-spread of literature throughout Europe.&#39;
    {
        &quot;person&quot;: [&quot;Johannes Gutenberg&quot;],
        &quot;org&quot;: [],
        &quot;gpe&quot;: [&quot;Germany&quot;, &quot;Europe&quot;]
    }
--
</code></pre></div></p>
<p><strong>Message 3: User Message</strong> (actual request)</p>
<p>When <code>vanilla_prompt=False</code> (Accern), the prompt includes signal metadata:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_user_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">signal</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">vanilla_prompt</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">vanilla_prompt</span><span class="p">:</span>
        <span class="c1"># Email version (no metadata)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;```</span><span class="se">\n</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="se">\n</span><span class="s2">```&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Accern version (with metadata)</span>
        <span class="n">entity_name</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entity_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">entity_type</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entity_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">doc_title</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;doc_title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">doc_url</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;doc_url&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            Given the source text below, extract named entities.</span>

<span class="s2">            Context:</span>
<span class="s2">            - Primary entity: </span><span class="si">{</span><span class="n">entity_name</span><span class="si">}</span>
<span class="s2">            - Entity type: </span><span class="si">{</span><span class="n">entity_type</span><span class="si">}</span>
<span class="s2">            - Document title: </span><span class="si">{</span><span class="n">doc_title</span><span class="si">}</span>
<span class="s2">            - Source: </span><span class="si">{</span><span class="n">doc_url</span><span class="si">}</span>

<span class="s2">            Text to analyze:</span>
<span class="s2">            ```</span>
<span class="s2">            </span><span class="si">{</span><span class="n">text</span><span class="si">}</span>
<span class="s2">            ```</span>
<span class="s2">        &quot;&quot;&quot;</span>
</code></pre></div>
<p><strong>Why metadata improves extraction</strong>:</p>
<p><em>Without metadata</em>:
<div class="highlight"><pre><span></span><code>Text: &quot;The company raised $10M from Accel.&quot;
Entities: [&quot;Accel&quot;]  # Ambiguous which company
</code></pre></div></p>
<p><em>With metadata</em>:
<div class="highlight"><pre><span></span><code>Text: &quot;The company raised $10M from Accel.&quot;
Context: entity_name: &quot;DeepTech&quot;, entity_type: &quot;Company&quot;, doc_title: &quot;DeepTech Secures Series A&quot;
Entities: [&quot;DeepTech&quot;, &quot;Accel&quot;]  # Clear primary entity + investor
</code></pre></div>
Note: This logic was put inplace to take advantage of Accern's metadata. However, this metadata actually does not usually have an entity name like "Accel". The most common entity name would be "Fintech Industry", which wouldnt be helpful for our LLM.</p>
<p><strong>Step 2c: Structured Output</strong></p>
<p>OpenAI is forced to return JSON matching the <code>OpenAiNerTags</code> schema:</p>
<div class="highlight"><pre><span></span><code><span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4o-2024-08-06&quot;</span><span class="p">,</span>
    <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
    <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">response_format</span><span class="o">=</span><span class="n">OpenAiNerTags</span>  <span class="c1"># Pydantic schema</span>
<span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">OpenAiNerTags</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">person</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>  <span class="c1"># [&quot;Jane Smith&quot;, &quot;John Doe&quot;]</span>
    <span class="n">org</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>     <span class="c1"># [&quot;DeepTech&quot;, &quot;Accel&quot;, &quot;Index Ventures&quot;]</span>
    <span class="n">gpe</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>     <span class="c1"># [&quot;San Francisco&quot;, &quot;New York&quot;]</span>
</code></pre></div>
<p><strong>Step 2d: Combine Results from All Chunks</strong></p>
<p>If the text was chunked, results are merged:</p>
<div class="highlight"><pre><span></span><code><span class="n">combined_ner_tags</span> <span class="o">=</span> <span class="n">OpenAiNerTags</span><span class="p">(</span><span class="n">person</span><span class="o">=</span><span class="p">[],</span> <span class="n">org</span><span class="o">=</span><span class="p">[],</span> <span class="n">gpe</span><span class="o">=</span><span class="p">[])</span>

<span class="k">for</span> <span class="n">ner_tags</span> <span class="ow">in</span> <span class="n">ner_tags_for_all_chunks</span><span class="p">:</span>
    <span class="n">combined_ner_tags</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ner_tags</span><span class="o">.</span><span class="n">person</span><span class="p">)</span>
    <span class="n">combined_ner_tags</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ner_tags</span><span class="o">.</span><span class="n">org</span><span class="p">)</span>
    <span class="n">combined_ner_tags</span><span class="o">.</span><span class="n">gpe</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ner_tags</span><span class="o">.</span><span class="n">gpe</span><span class="p">)</span>

<span class="k">return</span> <span class="n">combined_ner_tags</span>
</code></pre></div>
<p>Duplicates across chunks are not removed at this stage—that happens during filtering.</p>
<hr />
<p><strong>Email NER Extraction</strong> (<code>get_all_ner_tags</code> with <code>vanilla_prompt=True</code>)</p>
<p>The <code>get_entities_from_emails</code> op in <code>app/jobs/ingest_signals_from_emails.py</code> extracts entities without metadata:</p>
<div class="highlight"><pre><span></span><code><span class="n">extracted_entities</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">get_all_ner_tags</span><span class="p">(</span>
    <span class="n">preprocessed_text</span><span class="p">,</span>
    <span class="n">vanilla_prompt</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Simple prompt, no signal context</span>
<span class="p">)</span>
</code></pre></div>
<p>The user message is just the text wrapped in backticks:</p>
<div class="highlight"><pre><span></span><code>[preprocessed email text]
</code></pre></div>
<p><strong>Why no metadata for emails</strong>: Email signals lack structured metadata fields like <code>entity_name</code> or <code>entity_type</code>. The text itself must provide all context.</p>
<hr />
<p><strong>Summary of NER Labels</strong></p>
<p>OMVision extracts three entity types:</p>
<ul>
<li><strong>person</strong>: People (founders, investors, entrepreneurs, executives)</li>
<li><strong>org</strong>: Organizations (companies, startups, venture firms, institutions)</li>
<li><strong>gpe</strong>: Geopolitical entities (countries, cities, states)</li>
</ul>
<p>These labels are defined in <code>OpenAIResource.labels</code> and used consistently across preprocessing, extraction, and filtering.</p>
<hr />
<p><strong>3. Filter Entities with LLM</strong></p>
<p>Raw NER extraction often captures large corporations, government institutions, and celebrities—entities irrelevant to early-stage dealflow. The <code>filter_ner_tags</code> method (<code>app/resources/open_ai.py</code>) applies an LLM-based filter to remove these.</p>
<p>The <code>get_entities_from_signals</code> and <code>get_entities_from_emails</code> ops call:</p>
<div class="highlight"><pre><span></span><code><span class="n">filtered_entities</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">filter_ner_tags</span><span class="p">(</span>
    <span class="n">preprocessed_text</span><span class="p">,</span>      <span class="c1"># Same text used for extraction</span>
    <span class="n">extracted_entities</span>      <span class="c1"># Unfiltered OpenAiNerTags</span>
<span class="p">)</span>
</code></pre></div>
<p><strong>Filter Prompt</strong> (sent to <code>gpt-4o-2024-08-06</code>):</p>
<div class="highlight"><pre><span></span><code>You are an entity filtering AI assistant. There is a source text from which entities have 
been extracted; your task is to use the filtering criteria given below to remove entities 
from the original list of entities using the source text as context.

If you are unsure about the entity, retain it. Return ONLY the filtered entities that PASS 
the given criteria.

Each entity can be one of many different types. The description for the different entity types:
person (people, investors, entrepreneurs, etc.), org (organizations, companies, startups, 
agencies, institutions, etc.), gpe (geopolitical entities like countries, cities, states, etc.)

Follow these filtering criteria to eliminate entities from the original list:
1) Remove entities that may refer to big companies or major-tech firms like Meta, Google, 
   OpenAI, Disney, JP Morgan etc.
2) Remove entities that refer to public or government-owned institutions (e.g., European 
   Investment Bank)
3) Remove entities that refer to celebrities or public figures

[Examples with input/output pairs demonstrating filtering]
</code></pre></div>
<p><strong>Example</strong>:</p>
<p><em>Input</em>:
<div class="highlight"><pre><span></span><code>Source text: DeepTech, a healthcare AI startup, raised $10M in Series A. The funding round 
was led by Accel and Index Ventures. CEO Jane Smith previously worked at Google and Microsoft.

Extracted entities: 
{
    &quot;person&quot;: [&quot;Jane Smith&quot;],
    &quot;org&quot;: [&quot;DeepTech&quot;, &quot;Accel&quot;, &quot;Index Ventures&quot;, &quot;Google&quot;, &quot;Microsoft&quot;],
    &quot;gpe&quot;: []
}
</code></pre></div></p>
<p><em>Output</em>:
<div class="highlight"><pre><span></span><code>{
    &quot;person&quot;: [&quot;Jane Smith&quot;],
    &quot;org&quot;: [&quot;DeepTech&quot;, &quot;Accel&quot;, &quot;Index Ventures&quot;],
    &quot;gpe&quot;: []
}
</code></pre></div></p>
<p><strong>Why filtered</strong>:</p>
<ul>
<li><strong>Google</strong> and <strong>Microsoft</strong> are major tech firms → Removed (criterion #1)</li>
<li><strong>Jane Smith</strong> is not a celebrity → Retained</li>
<li><strong>DeepTech</strong> is a startup → Retained</li>
<li><strong>Accel</strong> and <strong>Index Ventures</strong> are VCs, not major corporations → Retained</li>
</ul>
<p><strong>Why this filter matters</strong>: Early removal of large corporations reduces downstream processing costs (URL search, Harmonic enrichment) and prevents these entities from polluting the database. This is an aggressive first pass; more sophisticated filtering happens in §3.2.3.</p>
<p><strong>Note</strong>: Both <code>extracted_entities</code> (raw) and <code>filtered_entities</code> are preserved for debugging and quality analysis.</p>
<hr />
<p><strong>4. Extract Entity Context</strong></p>
<p>The filtered entities now need contextual descriptors to enable URL discovery via Google Search. The <code>extract_entity_context_from_signals</code> and <code>extract_entity_context_from_emails</code> ops call:</p>
<div class="highlight"><pre><span></span><code><span class="n">signal_context</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">extract_context_from_signal</span><span class="p">(</span>
    <span class="n">original_text</span><span class="p">,</span>          <span class="c1"># ORIGINAL entity_text + event_text (not preprocessed)</span>
    <span class="n">filtered_entities</span>       <span class="c1"># Filtered OpenAiNerTags</span>
<span class="p">)</span>
</code></pre></div>
<p><strong>Why use original (unpreprocessed) text</strong>: Preprocessing removed tangential details, but those details are valuable for creating descriptive search queries. For example:</p>
<p><em>Preprocessed</em>: "DeepTech raised $10M"<br />
<em>Original</em>: "DeepTech, a healthcare AI startup focusing on diagnostic imaging, raised $10M"</p>
<p>The descriptors "healthcare AI" and "diagnostic imaging" are crucial for constructing a Google query like "DeepTech healthcare AI website".</p>
<p><strong>Context Extraction Prompt</strong> (sent to <code>gpt-4o-2024-08-06</code>):</p>
<div class="highlight"><pre><span></span><code>You are a content extraction assistant. A source text and corresponding list of entities will 
be given to you. Your task is to extract links and descriptors of entities from the given 
source text.

To aid you in your task, the definition for different entity types is mentioned below:
person (people, investors, entrepreneurs, etc.), org (organizations, companies, startups, 
agencies, institutions, etc.), gpe (geopolitical entities like countries, cities, states, etc.)

Follow the following instructions while performing the task:
1) Extract links for the entities only when it is explicitly mentioned in the source text. 
   Return an empty string otherwise.
2) For each entity, give a list of descriptors (or keywords) related to the entity using the 
   source text as context. Keep in mind that these descriptors will be used downstream for 
   searching the entity on Google, so keep them as generic as possible.
</code></pre></div>
<p><strong>Input to OpenAI</strong>:</p>
<div class="highlight"><pre><span></span><code>Source text: [&quot;DeepTech, a healthcare AI startup focusing on diagnostic imaging, raised $10M 
in Series A&quot;, &quot;The funding round was led by Accel and Index Ventures&quot;]

Extracted entities: {&quot;person&quot;: [&quot;Jane Smith&quot;], &quot;org&quot;: [&quot;DeepTech&quot;, &quot;Accel&quot;, &quot;Index Ventures&quot;], 
&quot;gpe&quot;: []}
</code></pre></div>
<p><strong>Output (<code>OpenAiSignalContext</code>)</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="n">OpenAiSignalContext</span><span class="p">(</span>
    <span class="n">companies</span><span class="o">=</span><span class="p">[</span>
        <span class="n">OpenAiEntityContext</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;DeepTech&quot;</span><span class="p">,</span>
            <span class="n">descriptors</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;healthcare AI startup&quot;</span><span class="p">,</span> <span class="s2">&quot;diagnostic imaging&quot;</span><span class="p">,</span> <span class="s2">&quot;Series A funding&quot;</span><span class="p">],</span>
            <span class="n">link</span><span class="o">=</span><span class="s2">&quot;&quot;</span>  <span class="c1"># No URL explicitly mentioned in text</span>
        <span class="p">),</span>
        <span class="n">OpenAiEntityContext</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Accel&quot;</span><span class="p">,</span>
            <span class="n">descriptors</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;venture capital&quot;</span><span class="p">,</span> <span class="s2">&quot;Series A investor&quot;</span><span class="p">],</span>
            <span class="n">link</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="p">),</span>
        <span class="n">OpenAiEntityContext</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Index Ventures&quot;</span><span class="p">,</span>
            <span class="n">descriptors</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;venture capital&quot;</span><span class="p">,</span> <span class="s2">&quot;Series A investor&quot;</span><span class="p">],</span>
            <span class="n">link</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
    <span class="p">],</span>
    <span class="n">people</span><span class="o">=</span><span class="p">[</span>
        <span class="n">OpenAiEntityContext</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Jane Smith&quot;</span><span class="p">,</span>
            <span class="n">descriptors</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CEO&quot;</span><span class="p">,</span> <span class="s2">&quot;DeepTech&quot;</span><span class="p">],</span>
            <span class="n">link</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</code></pre></div>
<p><strong>What this achieves</strong>: Each entity now has:</p>
<ul>
<li><strong>Descriptors</strong>: Keywords optimized for Google/LinkedIn search</li>
<li><strong>Links</strong>: Extracted only if explicitly mentioned in the text (usually empty)</li>
</ul>
<p>These descriptors are critical for the next step (URL enrichment).</p>
<hr />
<p><strong>5. URL Enrichment</strong></p>
<p>The URL enrichment process has two paths:</p>
<ol>
<li><strong>Match path</strong>: If the entity already has a link from context extraction, validate it</li>
<li><strong>Fetch path</strong>: If no link exists, search Google and find the best match</li>
</ol>
<p><strong>From <code>app/resources/web_search.py</code>:</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">match_or_fetch_company_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">company</span><span class="p">:</span> <span class="n">OpenAiEntityContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Matches or fetches a company URL based on the company&#39;s name and descriptors.</span>

<span class="sd">    Args:</span>
<span class="sd">        company: The company entity context.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The matched or fetched company URL.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Try to match with existing link first</span>
    <span class="n">matched_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_entity_with_url</span><span class="p">(</span><span class="n">company</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">matched_url</span><span class="p">:</span>
        <span class="c1"># No match found, search Google</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">company</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">company</span><span class="o">.</span><span class="n">descriptors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">company</span><span class="o">.</span><span class="n">descriptors</span>
            <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">company</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> website&quot;</span>
        <span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_google_custom_search</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">matched_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_best_match</span><span class="p">(</span>
            <span class="n">results</span><span class="p">,</span>
            <span class="n">company</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">company</span><span class="o">.</span><span class="n">descriptors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">company</span><span class="o">.</span><span class="n">descriptors</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">matched_url</span>
</code></pre></div>
<p><strong>Path 1: Matching with Existing Link</strong></p>
<p>If context extraction found a link, validate it using fuzzy matching:</p>
<p><strong>From <code>app/resources/web_search.py</code>:</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_match_entity_with_url</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">entity</span><span class="p">:</span> <span class="n">OpenAiEntityContext</span><span class="p">,</span>
    <span class="n">entity_type</span><span class="p">:</span> <span class="n">EntityType</span> <span class="o">=</span> <span class="n">EntityType</span><span class="o">.</span><span class="n">org</span><span class="p">,</span>
    <span class="n">match_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Matches an entity (person or organization) with a URL by performing fuzzy </span>
<span class="sd">    matching on the entity&#39;s name and the URL.</span>

<span class="sd">    Args:</span>
<span class="sd">        entity: The entity to match.</span>
<span class="sd">        entity_type: The type of the entity (default: EntityType.org).</span>
<span class="sd">        match_threshold: The minimum score required for a match (default: 80).</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The matched URL or an empty string if no match is found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">entity_link</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="n">entity_type</span> <span class="o">==</span> <span class="n">EntityType</span><span class="o">.</span><span class="n">person</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;linkedin.com/in&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entity</span><span class="o">.</span><span class="n">link</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">entity_link</span>

    <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">link</span><span class="p">:</span>
        <span class="n">parsed_entity_link</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">link</span><span class="p">)</span>
        <span class="n">extracted_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_company_name_from_link</span><span class="p">(</span><span class="n">parsed_entity_link</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">entity_type</span> <span class="o">==</span> <span class="n">EntityType</span><span class="o">.</span><span class="n">org</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_profile_name_from_link</span><span class="p">(</span><span class="n">parsed_entity_link</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">match_score</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_match_scores</span><span class="p">(</span><span class="n">extracted_name</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">match_score</span> <span class="o">&gt;=</span> <span class="n">match_threshold</span><span class="p">:</span>
            <span class="n">entity_link</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">link</span>

    <span class="k">return</span> <span class="n">entity_link</span>
</code></pre></div>
<p><strong>Example matching:</strong></p>
<p><strong>Input:</strong>
<div class="highlight"><pre><span></span><code><span class="n">company</span> <span class="o">=</span> <span class="n">OpenAiEntityContext</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Deepnote&quot;</span><span class="p">,</span>
    <span class="n">link</span><span class="o">=</span><span class="s2">&quot;deepnote.com&quot;</span><span class="p">,</span>
    <span class="n">descriptors</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;collaborative data notebook&quot;</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div></p>
<p><strong>Process:</strong></p>
<ol>
<li>Parse URL: <code>deepnote.com</code> → domain name: <code>deepnote</code></li>
<li>Fuzzy match: <code>fuzz.partial_ratio("deepnote", "Deepnote")</code> → 100</li>
<li>Score &gt;= 80, so return <code>deepnote.com</code></li>
</ol>
<p><strong>For people:</strong></p>
<p><strong>Input:</strong>
<div class="highlight"><pre><span></span><code><span class="n">person</span> <span class="o">=</span> <span class="n">OpenAiEntityContext</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Jane Smith&quot;</span><span class="p">,</span>
    <span class="n">link</span><span class="o">=</span><span class="s2">&quot;linkedin.com/in/jane-smith-123&quot;</span><span class="p">,</span>
    <span class="n">descriptors</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CEO&quot;</span><span class="p">,</span> <span class="s2">&quot;Deepnote&quot;</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div></p>
<p><strong>Process:</strong></p>
<ol>
<li>Check if link contains <code>linkedin.com/in</code> → Yes</li>
<li>Parse URL: <code>jane-smith-123</code></li>
<li>Fuzzy match: <code>fuzz.partial_ratio("jane-smith-123", "Jane Smith")</code> → ~70</li>
<li>Score &lt; 80, so return empty string (will trigger Google search)</li>
</ol>
<p><strong>Path 2: Fetching with Google Search</strong></p>
<p>If no valid link exists, search Google and find the best match:</p>
<p><strong>From <code>app/resources/web_search.py</code>:</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_google_custom_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">website</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs a Google Custom Search query using the provided search query and </span>
<span class="sd">    optionally limits the search to a specific website.</span>

<span class="sd">    Args:</span>
<span class="sd">        query: The search query.</span>
<span class="sd">        website: The website to limit the search to (default: None).</span>

<span class="sd">    Returns:</span>
<span class="sd">        list[dict]: A list of search results from Google Custom Search.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_rate_limiter</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">website</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_service</span><span class="o">.</span><span class="n">cse</span><span class="p">()</span>
            <span class="o">.</span><span class="n">list</span><span class="p">(</span>
                <span class="n">q</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                <span class="n">cx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cse_id</span><span class="p">,</span>
                <span class="n">siteSearch</span><span class="o">=</span><span class="n">website</span><span class="p">,</span>
                <span class="n">siteSearchFilter</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_service</span><span class="o">.</span><span class="n">cse</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">cx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cse_id</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>
<p><strong>Resource configuration</strong> (from <code>app/main.py</code>):</p>
<div class="highlight"><pre><span></span><code><span class="s2">&quot;google&quot;</span><span class="p">:</span> <span class="n">WebSearchResource</span><span class="p">(</span>
    <span class="n">api_key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GOOGLE_SEARCH_API_KEY&quot;</span><span class="p">),</span>
    <span class="n">cse_id</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;GOOGLE_SEARCH_ENGINE_ID&quot;</span><span class="p">),</span>
<span class="p">),</span>
</code></pre></div>
<p><strong>Rate limiting</strong> is enforced to respect Google's API limits (100 searches per minute):</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">setup_for_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">InitResourceContext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up the Google Custom Search API service and the rate limiter for job execution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_service</span> <span class="o">=</span> <span class="n">build</span><span class="p">(</span><span class="s2">&quot;customsearch&quot;</span><span class="p">,</span> <span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="n">developerKey</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_rate_limiter</span> <span class="o">=</span> <span class="n">RateLimiter</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>  <span class="c1"># 100 requests per 60 seconds</span>
</code></pre></div>
<p><strong>Example Google search query for company:</strong></p>
<div class="highlight"><pre><span></span><code>Query: &quot;Deepnote collaborative data notebook platform&quot;
</code></pre></div>
<p><strong>Example Google search query for person:</strong></p>
<div class="highlight"><pre><span></span><code>Query: &quot;Jane Smith CEO Deepnote&quot;
Website filter: &quot;linkedin.com/in&quot;
</code></pre></div>
<p><strong>Finding the Best Match</strong></p>
<p>After getting Google search results, find the best match using fuzzy matching:</p>
<p><strong>From <code>app/resources/web_search.py</code>:</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_find_best_match</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">results</span><span class="p">,</span>
    <span class="n">entity_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">entity_descriptor</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">entity_type</span><span class="p">:</span> <span class="n">EntityType</span> <span class="o">=</span> <span class="n">EntityType</span><span class="o">.</span><span class="n">org</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds the best match for an entity (person or organization) from the search </span>
<span class="sd">    results based on match and similarity scores.</span>

<span class="sd">    Args:</span>
<span class="sd">        results: A list of search results.</span>
<span class="sd">        entity_name: The name of the entity to match.</span>
<span class="sd">        entity_descriptor: A descriptor for the entity.</span>
<span class="sd">        entity_type: The type of the entity (default: EntityType.org).</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The URL of the best match.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">highest_match_score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">highest_similarity_score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">best_match_url</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">result_title</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">result_link</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result_link</span><span class="p">:</span>
            <span class="n">parsed_link</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">result_link</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">entity_type</span> <span class="o">==</span> <span class="n">EntityType</span><span class="o">.</span><span class="n">person</span><span class="p">:</span>
                <span class="n">result_title</span> <span class="o">=</span> <span class="n">result_title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; | LinkedIn&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">extracted_name_from_link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_profile_name_from_link</span><span class="p">(</span>
                    <span class="n">parsed_link</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">extracted_name_from_link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_company_name_from_link</span><span class="p">(</span>
                    <span class="n">parsed_link</span>
                <span class="p">)</span>

            <span class="n">match_score</span><span class="p">,</span> <span class="n">similarity_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_match_scores</span><span class="p">(</span>
                <span class="n">extracted_name_from_link</span><span class="p">,</span>
                <span class="n">result_title</span><span class="p">,</span>
                <span class="n">entity_name</span><span class="p">,</span>
                <span class="n">entity_descriptor</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">match_score</span> <span class="o">&gt;</span> <span class="n">highest_match_score</span><span class="p">:</span>
                <span class="n">highest_match_score</span> <span class="o">=</span> <span class="n">match_score</span>

                <span class="k">if</span> <span class="n">similarity_score</span> <span class="o">&gt;</span> <span class="n">highest_similarity_score</span><span class="p">:</span>
                    <span class="n">highest_similarity_score</span> <span class="o">=</span> <span class="n">similarity_score</span>
                    <span class="n">best_match_url</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">parsed_link</span><span class="o">.</span><span class="n">scheme</span>
                        <span class="o">+</span> <span class="s2">&quot;://&quot;</span>
                        <span class="o">+</span> <span class="n">parsed_link</span><span class="o">.</span><span class="n">netloc</span>
                        <span class="o">+</span> <span class="n">parsed_link</span><span class="o">.</span><span class="n">path</span>
                    <span class="p">)</span>

    <span class="k">return</span> <span class="n">best_match_url</span>
</code></pre></div>
<p><strong>Fuzzy matching logic</strong> (from <code>app/resources/web_search.py</code>):</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_get_match_scores</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">profile_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">result_title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">person_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">person_descriptor</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">match_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span>
    <span class="n">similarity_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the match score and similarity score between a profile name and a </span>
<span class="sd">    result title based on fuzzy string matching.</span>

<span class="sd">    Args:</span>
<span class="sd">        profile_name: The extracted profile name or company name from the result.</span>
<span class="sd">        result_title: The title of the search result.</span>
<span class="sd">        person_name: The name of the person to match.</span>
<span class="sd">        person_descriptor: The descriptor of the person to match.</span>
<span class="sd">        match_threshold: The minimum score required for a match (default: 80).</span>
<span class="sd">        similarity_threshold: The minimum score required for a similarity match (default: 25).</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[int, int]: A tuple containing the match score and similarity score.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">match_score</span> <span class="o">=</span> <span class="n">fuzz</span><span class="o">.</span><span class="n">partial_ratio</span><span class="p">(</span><span class="n">profile_name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">person_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">match_score</span> <span class="o">&gt;=</span> <span class="n">match_threshold</span><span class="p">:</span>
        <span class="n">similarity_score</span> <span class="o">=</span> <span class="n">fuzz</span><span class="o">.</span><span class="n">partial_ratio</span><span class="p">(</span>
            <span class="n">person_descriptor</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">result_title</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">similarity_score</span> <span class="o">&gt;=</span> <span class="n">similarity_threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">match_score</span><span class="p">,</span> <span class="n">similarity_score</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">match_score</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
</code></pre></div>
<p><strong>How the matching algorithm works:</strong></p>
<ol>
<li><strong>Match score</strong>: Fuzzy match between extracted URL name and entity name</li>
<li>Must be &gt;= 80 to be considered</li>
<li><strong>Similarity score</strong>: Fuzzy match between entity descriptor and search result title</li>
<li>Must be &gt;= 25 to be considered</li>
<li>Used as a tiebreaker when multiple results have high match scores</li>
</ol>
<p><strong>Example:</strong></p>
<p><strong>Google search results for "Deepnote collaborative data notebook":</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">results</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Deepnote - Collaborative Data Notebook Platform&quot;</span><span class="p">,</span>
        <span class="s2">&quot;link&quot;</span><span class="p">:</span> <span class="s2">&quot;https://deepnote.com&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Deepnote | Crunchbase&quot;</span><span class="p">,</span>
        <span class="s2">&quot;link&quot;</span><span class="p">:</span> <span class="s2">&quot;https://crunchbase.com/organization/deepnote&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Deepnote Review - TechCrunch&quot;</span><span class="p">,</span>
        <span class="s2">&quot;link&quot;</span><span class="p">:</span> <span class="s2">&quot;https://techcrunch.com/deepnote-review&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>
</code></pre></div>
<p><strong>Scoring:</strong></p>
<table>
<thead>
<tr>
<th>Result</th>
<th>Extracted Name</th>
<th>Match Score</th>
<th>Similarity Score</th>
<th>Selected?</th>
</tr>
</thead>
<tbody>
<tr>
<td>deepnote.com</td>
<td>deepnote</td>
<td>100</td>
<td>95 (title contains "collaborative data notebook")</td>
<td><strong>Yes</strong></td>
</tr>
<tr>
<td>crunchbase.com</td>
<td>crunchbase</td>
<td>0</td>
<td>N/A</td>
<td>No</td>
</tr>
<tr>
<td>techcrunch.com</td>
<td>techcrunch</td>
<td>0</td>
<td>N/A</td>
<td>No</td>
</tr>
</tbody>
</table>
<p><strong>Best match:</strong> <code>https://deepnote.com</code> with match_score=100, similarity_score=95</p>
<p>The URL is stored in the entity context's <code>link</code> field.</p>
<hr />
<p><strong>6. Company Filter Based on Filter List</strong></p>
<p>After URL enrichment, a final entity-level filter is applied to remove companies on the manual exclusion list. The <code>filter_entities</code> op (<code>app/ops/__init__.py</code>) compares enriched entities against the <code>company_filter_list</code> asset.</p>
<p><strong>Filter List Source</strong>:</p>
<p>The list is maintained in Harmonic as a saved search named "DealFlow - Filter list". Companies added to this search are explicitly marked as irrelevant (e.g., large consultancies, media outlets, repeatedly misidentified entities).</p>
<p>The <code>company_filter_list</code> asset (<code>app/assets/company_filters.py</code>) fetches this list:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@asset</span>
<span class="k">def</span><span class="w"> </span><span class="nf">company_filter_list</span><span class="p">(</span><span class="n">harmonic</span><span class="p">:</span> <span class="n">HarmonicResource</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">filter_search</span> <span class="o">=</span> <span class="n">harmonic</span><span class="o">.</span><span class="n">get_filter_search</span><span class="p">()</span>  <span class="c1"># &quot;DealFlow - Filter list&quot;</span>
    <span class="n">company_ids</span> <span class="o">=</span> <span class="n">harmonic</span><span class="o">.</span><span class="n">get_companies_by_search</span><span class="p">(</span><span class="n">filter_search</span><span class="o">.</span><span class="n">entity_urn</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">company</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">company</span> <span class="ow">in</span> <span class="n">company_ids</span><span class="p">]</span>
</code></pre></div>
<p><strong>Filtering Logic</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">filter_entities</span><span class="p">(</span><span class="n">company_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">entities</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">NerTags</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">NerTags</span><span class="p">]:</span>
    <span class="n">filtered_entities</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">entity_tags</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
        <span class="n">filtered_org</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">company_name</span><span class="p">:</span> <span class="n">url</span>
            <span class="k">for</span> <span class="n">company_name</span><span class="p">,</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">entity_tags</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">company_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">company_names</span>  <span class="c1"># Exclude if in filter list</span>
        <span class="p">}</span>

        <span class="n">filtered_entities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">NerTags</span><span class="p">(</span>
                <span class="n">person</span><span class="o">=</span><span class="n">entity_tags</span><span class="o">.</span><span class="n">person</span><span class="p">,</span>  <span class="c1"># People are not filtered here</span>
                <span class="n">org</span><span class="o">=</span><span class="n">filtered_org</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">filtered_entities</span>
</code></pre></div>
<p><strong>Why this filter exists</strong>: The LLM filter (step 3) removes well-known large corporations, but cannot anticipate domain-specific noise. The manual filter list captures entities that:</p>
<ul>
<li>Repeatedly appear in signals but are irrelevant (e.g., "TechCrunch", "Bloomberg")</li>
<li>Are misidentified by NER (e.g., "Ventures" as a standalone company)</li>
<li>Are outside investment scope but pass other filters (e.g., government labs)</li>
</ul>
<p>This list is continuously maintained by the investment team, improving system accuracy over time.</p>
<hr />
<p><strong>7. Signal Storage</strong></p>
<p>The <code>combine_signals_and_entities</code> (Accern) or <code>combine_emails_and_entities</code> (Gmail) op merges all extracted and processed information back into signal objects for storage.</p>
<p><strong>Signal Structure</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="n">SignalCreate</span><span class="p">(</span>
    <span class="n">source_id</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>               <span class="c1"># Link to Accern/Gmail source</span>
    <span class="n">source_data</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span>   <span class="c1"># Original raw signal JSON (audit trail)</span>
    <span class="n">raw_entity_tags</span><span class="o">=</span><span class="n">raw_entities</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span>    <span class="c1"># Unfiltered entities (OpenAiNerTags)</span>
    <span class="n">ner_tags</span><span class="o">=</span><span class="n">filtered_entities</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>       <span class="c1"># Filtered entities with URLs (NerTags)</span>
<span class="p">)</span>
</code></pre></div>
<p>Each signal now contains:</p>
<ul>
<li><strong><code>source_data</code></strong>: Original Accern signal JSON or email metadata (preserved for audit/debugging)</li>
<li><strong><code>raw_ner_tags</code></strong>: Unfiltered entity lists from OpenAI (for quality analysis)</li>
<li><strong><code>ner_tags</code></strong>: Filtered entities with URLs, formatted as:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="s2">&quot;person&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Jane Smith&quot;</span><span class="p">:</span> <span class="s2">&quot;https://linkedin.com/in/jane-smith&quot;</span><span class="p">},</span>
    <span class="s2">&quot;org&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;DeepTech&quot;</span><span class="p">:</span> <span class="s2">&quot;https://deeptech.ai&quot;</span><span class="p">,</span> <span class="s2">&quot;Accel&quot;</span><span class="p">:</span> <span class="s2">&quot;https://accel.com&quot;</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>Database Insertion</strong>:</p>
<p>The <code>store_in_db</code> or <code>store_email_signals_in_db</code> op bulk inserts signals:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@op</span>
<span class="k">def</span><span class="w"> </span><span class="nf">store_in_db</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">DatabaseResource</span><span class="p">,</span> <span class="n">all_signals</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">SignalCreate</span><span class="p">]):</span>
    <span class="n">parsed_signals</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Signal</span><span class="p">(</span>
            <span class="n">source_id</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">source_id</span><span class="p">,</span>
            <span class="n">source_data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">source_data</span><span class="p">,</span>
            <span class="n">raw_ner_tags</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">raw_entity_tags</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span>
            <span class="n">ner_tags</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">entity_tags</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(),</span>
            <span class="n">source_company_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># ← Marker for unenriched signals</span>
            <span class="n">source_people_ids</span><span class="o">=</span><span class="kc">None</span>    <span class="c1"># ← Marker for unenriched signals</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">all_signals</span>
    <span class="p">]</span>
    <span class="n">db</span><span class="o">.</span><span class="n">bulk_insert_rows</span><span class="p">(</span><span class="n">parsed_signals</span><span class="p">)</span>
</code></pre></div>
<p><strong>Critical detail</strong>: <code>source_company_ids</code> and <code>source_people_ids</code> are set to <code>NULL</code>. This NULL value signals that entity extraction has completed but enrichment has not yet occurred. Downstream enrichment jobs (§3.2.3) query for signals where these fields are NULL to identify work remaining.</p>
<hr />
<h3 id="323-data-enrichment">3.2.3 Data Enrichment<a class="headerlink" href="#323-data-enrichment" title="Permanent link">&para;</a></h3>
<p>Data enrichment transforms extracted entity names and URLs into fully detailed company and people records by querying Harmonic's B2B intelligence platform. This stage retrieves comprehensive firmographic data (funding, headcount, location, team composition) that enables investment thesis filtering and classification.</p>
<p>Enrichment operates on signals created in §3.2.2, processing companies and people separately through parallel jobs. The workflow combines name-based searching, URL-based enrichment, and investment criteria filtering to produce the final set of qualified entities.</p>
<h4 id="company-enrichment-workflow">Company Enrichment Workflow<a class="headerlink" href="#company-enrichment-workflow" title="Permanent link">&para;</a></h4>
<p>The <code>ingest_companies_from_signals</code> job (<code>app/jobs/ingest_companies_from_signals.py</code>) orchestrates an eight-step process detailed in <code>company_enrichment_flow.md</code>:</p>
<p><strong>1. Fetch Signals</strong> (<code>get_all_signals_from_source</code>)</p>
<p>Retrieves signals for the specified source (Accern or Gmail) where <code>source_company_ids</code> is NULL:</p>
<div class="highlight"><pre><span></span><code><span class="n">signals</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">fetch_data</span><span class="p">(</span><span class="n">Signal</span><span class="o">.</span><span class="n">source_company_ids</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">parsed_signals</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">signal</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">data_source</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">signal</span><span class="o">.</span><span class="n">source_id</span><span class="p">:</span>
        <span class="n">parsed_signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SignalWithTags</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">ner_tags</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">ner_tags</span><span class="p">))</span>
</code></pre></div>
<p>These represent signals with extracted entities (from §3.2.2) awaiting enrichment.</p>
<p><strong>2. Search Companies by Name</strong> (<code>search_companies_with_harmonic</code>)</p>
<p>For each unique company name in the signal NER tags, the system performs a name-based search in Harmonic:</p>
<div class="highlight"><pre><span></span><code><span class="n">unique_company_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="k">for</span> <span class="n">signal</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">signal</span><span class="o">.</span><span class="n">ner_tags</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">company_name</span> <span class="ow">in</span> <span class="n">signal</span><span class="o">.</span><span class="n">ner_tags</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">unique_company_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">company_name</span><span class="p">)</span>

<span class="n">company_search_results</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">company_name</span> <span class="ow">in</span> <span class="n">unique_company_names</span><span class="p">:</span>
    <span class="n">company_search_results</span><span class="p">[</span><span class="n">company_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">harmonic</span><span class="o">.</span><span class="n">search_and_match_company</span><span class="p">(</span><span class="n">company_name</span><span class="p">)</span>
</code></pre></div>
<p><strong>How <code>search_and_match_company</code> works</strong> (<code>app/resources/harmonic_api.py</code>):</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">search_and_match_company</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">company_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CompanyBase</span><span class="p">]:</span>
    <span class="n">search_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conduct_search</span><span class="p">(</span><span class="n">company_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">search_results</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">company</span> <span class="ow">in</span> <span class="n">search_results</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">company</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">company_name</span><span class="p">:</span>  <span class="c1"># Exact match</span>
                <span class="k">return</span> <span class="n">company</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
<p>The <code>conduct_search</code> method:</p>
<ol>
<li>Makes a POST request to <code>https://api.harmonic.ai/search/companies_by_keywords</code></li>
<li>Sends <code>{"keywords": company_name}</code> as the request body</li>
<li>Returns a list of matching companies (Harmonic may return multiple results if companies share names)</li>
<li>Searches the results for an exact name match</li>
<li>Returns the first exact match if found, otherwise <code>None</code></li>
</ol>
<p><strong>Important</strong>: Every company goes through this name search, regardless of whether a URL was found in §3.2.2. URLs are used later to override name matches when available.</p>
<p><strong>3. Parse Matched Companies</strong> (<code>parse_matched_companies</code>)</p>
<p>This operation makes the critical decision about which companies need URL-based enrichment:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">signal</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
    <span class="n">companies_to_be_enriched</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">companies_matched</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">signal</span><span class="o">.</span><span class="n">ner_tags</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">company_name</span><span class="p">,</span> <span class="n">company_url</span> <span class="ow">in</span> <span class="n">signal</span><span class="o">.</span><span class="n">ner_tags</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">matched_company</span> <span class="o">=</span> <span class="n">harmonic_search_results</span><span class="p">[</span><span class="n">company_name</span><span class="p">]</span>

            <span class="n">raw_company</span> <span class="o">=</span> <span class="n">CompanyBase</span><span class="p">(</span>
                <span class="n">website</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">company_url</span><span class="p">},</span>
                <span class="n">name</span><span class="o">=</span><span class="n">company_name</span>
            <span class="p">)</span>

            <span class="c1"># Decision logic</span>
            <span class="k">if</span> <span class="n">company_url</span> <span class="ow">or</span> <span class="n">matched_company</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">companies_to_be_enriched</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">raw_company</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">companies_matched</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">matched_company</span><span class="p">)</span>
</code></pre></div>
<p><strong>Decision Tree</strong>:</p>
<p>A company goes to the <strong>"to enrich"</strong> list if:</p>
<ul>
<li><strong>The NER tag has a URL</strong> (<code>company_url</code> exists), OR</li>
<li><strong>No match was found in the name search</strong> (<code>matched_company is None</code>)</li>
</ul>
<p>A company goes to the <strong>"matched/already enriched"</strong> list if:</p>
<ul>
<li><strong>There is an exact name match from search</strong>, AND</li>
<li><strong>The NER tag has NO URL</strong></li>
</ul>
<p><strong>Key Insight</strong>: If a URL exists in the NER tags, the system assumes the name search might not be accurate enough. It prefers to enrich by URL for better precision. If there's no URL and no name match, the system still attempts enrichment by name (with an empty URL string).</p>
<p><strong>4. Enrich by URL</strong> (<code>enrich_companies_with_harmonic</code>)</p>
<p>For companies in the "to enrich" list, the system queries Harmonic by website URL:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">signal</span> <span class="ow">in</span> <span class="n">signals_with_companies</span><span class="p">:</span>
    <span class="n">companies_enriched</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unknown_companies</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">company</span> <span class="ow">in</span> <span class="n">signal</span><span class="o">.</span><span class="n">companies</span><span class="p">:</span>
        <span class="n">company_url</span> <span class="o">=</span> <span class="n">company</span><span class="o">.</span><span class="n">website</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">company_url</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">enriched_company</span> <span class="o">=</span> <span class="n">harmonic</span><span class="o">.</span><span class="n">enrich_company</span><span class="p">(</span><span class="s2">&quot;website_url&quot;</span><span class="p">,</span> <span class="n">company_url</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">enriched_company</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">unknown_companies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">company</span><span class="p">)</span>  <span class="c1"># URL not found in Harmonic</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">companies_enriched</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">enriched_company</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No URL - company goes through as &quot;unknown&quot; with just name</span>
            <span class="n">unknown_companies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">company</span><span class="p">)</span>
</code></pre></div>
<p><strong>How <code>enrich_company</code> works</strong> (<code>app/resources/harmonic_api.py</code>):</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">enrich_company</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">identifier_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CompanyBase</span><span class="p">]:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">identifier_type</span><span class="p">:</span> <span class="n">identifier_value</span><span class="p">}</span>  <span class="c1"># {&quot;website_url&quot;: &quot;https://deeptech.ai&quot;}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span><span class="si">}</span><span class="s2">companies&quot;</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">CompanyBase</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API call failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
<p>The <code>POST /companies</code> endpoint:</p>
<ul>
<li>Accepts <code>website_url</code>, <code>linkedin_url</code>, or <code>id</code> as identifier types</li>
<li>Returns a fully enriched <code>CompanyBase</code> object if found</li>
<li>Returns HTTP 404 if the URL is not in Harmonic's database</li>
</ul>
<p><strong>What "enriched" means</strong>: A <code>CompanyBase</code> object contains:</p>
<ul>
<li><strong>Core attributes</strong>: name, legal_name, description, contact, founding_date, website_urls, logo_url, ownership_status, location, tags, socials</li>
<li><strong>Metrics</strong>: stage, headcount, traction_metrics (web traffic, social metrics), funding details, investor URNs, funding_rounds</li>
<li><strong>People</strong>: employees with roles, LinkedIn profiles, experience, education</li>
<li><strong>Highlights</strong>: company highlights (partnerships, products) and employee highlights (former employers, skills)</li>
</ul>
<p><strong>What happens if enrichment fails</strong>: Companies that couldn't be enriched (URL not in Harmonic or empty URL) are marked as "unknown companies" and stored with minimal information (name and URL only). They are included in the results but typically filtered out in the next step.</p>
<p><strong>5. Filter Companies</strong> (<code>filter_companies</code>)</p>
<p>The filter applies investment thesis criteria to remove companies outside OMVC's target profile:</p>
<div class="highlight"><pre><span></span><code><span class="n">filtered_companies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">updated_signals</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">signal</span> <span class="ow">in</span> <span class="n">searched_companies</span> <span class="o">+</span> <span class="n">enriched_companies</span><span class="p">:</span>
    <span class="n">signal_company_ids</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">company</span> <span class="ow">in</span> <span class="n">signal</span><span class="o">.</span><span class="n">companies</span><span class="p">:</span>
        <span class="c1"># Filter 1: Has investor URN (company is an investor, not a portfolio company)</span>
        <span class="k">if</span> <span class="n">company</span><span class="o">.</span><span class="n">investor_urn</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Filter 2: Location not in approved list</span>
        <span class="k">if</span> <span class="n">company</span><span class="o">.</span><span class="n">location</span><span class="p">:</span>
            <span class="n">country</span> <span class="o">=</span> <span class="n">company</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;country&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">country</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">country</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">LOCATION_FILTER_LIST</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="c1"># Filter 3: Funding round not in target stages</span>
        <span class="k">if</span> <span class="n">company</span><span class="o">.</span><span class="n">stage</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">company</span><span class="o">.</span><span class="n">stage</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FUNDING_ROUND_FILTER_LIST</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="c1"># Filter 4: Total funding exceeds limit</span>
        <span class="k">if</span> <span class="n">company</span><span class="o">.</span><span class="n">funding</span><span class="p">:</span>
            <span class="n">funding_total</span> <span class="o">=</span> <span class="n">company</span><span class="o">.</span><span class="n">funding</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;funding_total&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">funding_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">funding_total</span> <span class="o">&gt;=</span> <span class="n">FUNDING_AMOUNT_LIMIT</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="c1"># Filter 5: Headcount exceeds limit</span>
        <span class="k">if</span> <span class="n">company</span><span class="o">.</span><span class="n">headcount</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">company</span><span class="o">.</span><span class="n">headcount</span> <span class="o">&gt;</span> <span class="n">COMPANY_HEADCOUNT_LIMIT</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="c1"># Company passed all filters</span>
        <span class="n">filtered_companies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CompanyWithSignalId</span><span class="p">(</span><span class="n">signal_id</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="o">**</span><span class="n">company</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()))</span>
        <span class="n">signal_company_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">company</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="n">updated_signals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SignalWithCompanyIds</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">signal</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">source_company_ids</span><span class="o">=</span><span class="n">signal_company_ids</span><span class="p">))</span>
</code></pre></div>
<p><strong>Filter Criteria</strong> (from <code>app/constants/company_filters.py</code>):</p>
<ul>
<li><strong>Investor profiles</strong>: Companies with <code>investor_urn</code> are classified as investors, not portfolio companies → Excluded</li>
<li><strong>Location</strong>: Country must be in <code>LOCATION_FILTER_LIST</code>:
  <div class="highlight"><pre><span></span><code><span class="n">LOCATION_FILTER_LIST</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;United States&quot;</span><span class="p">,</span> <span class="s2">&quot;Singapore&quot;</span><span class="p">,</span> <span class="s2">&quot;Thailand&quot;</span><span class="p">,</span> <span class="s2">&quot;Australia&quot;</span><span class="p">,</span> <span class="s2">&quot;Canada&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;United Arab Emirates&quot;</span><span class="p">,</span> <span class="s2">&quot;Egypt&quot;</span><span class="p">,</span> <span class="s2">&quot;Saudi Arabia&quot;</span><span class="p">,</span> <span class="s2">&quot;New Zealand&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;Philippines&quot;</span><span class="p">,</span> <span class="s2">&quot;Indonesia&quot;</span><span class="p">,</span> <span class="s2">&quot;Malaysia&quot;</span><span class="p">,</span> <span class="s2">&quot;Hong Kong&quot;</span><span class="p">,</span> <span class="s2">&quot;Vietnam&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;Japan&quot;</span><span class="p">,</span> <span class="s2">&quot;South Korea&quot;</span>
<span class="p">]</span>
</code></pre></div></li>
<li><strong>Funding round</strong>: Stage must be in <code>FUNDING_ROUND_FILTER_LIST</code>:
  <div class="highlight"><pre><span></span><code><span class="n">FUNDING_ROUND_FILTER_LIST</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;PRE_SEED&quot;</span><span class="p">,</span> <span class="s2">&quot;SEED&quot;</span><span class="p">,</span> <span class="s2">&quot;SERIES_A&quot;</span><span class="p">,</span> <span class="s2">&quot;SERIES_B&quot;</span><span class="p">,</span> <span class="s2">&quot;VENTURE_UNKNOWN&quot;</span><span class="p">,</span> <span class="s2">&quot;STEALTH&quot;</span>
<span class="p">]</span>
</code></pre></div>
  (Excludes late-stage: Series C+, growth equity, etc.)</li>
<li><strong>Total funding</strong>: <code>funding_total &lt; $15,000,000</code></li>
<li><strong>Headcount</strong>: <code>headcount ≤ 50</code> employees</li>
</ul>
<p><strong>Purpose</strong>: These filters enforce OMVC's investment thesis, removing companies that are too mature, too large, geographically misaligned, or are investors themselves rather than operating companies.</p>
<p>The operation logs filter breakdown:</p>
<div class="highlight"><pre><span></span><code><span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;Filter breakdown - Investors: </span><span class="si">{</span><span class="n">investors_filtered</span><span class="si">}</span><span class="s2">, Location: </span><span class="si">{</span><span class="n">location_filtered</span><span class="si">}</span><span class="s2">, &quot;</span>
    <span class="sa">f</span><span class="s2">&quot;Funding round: </span><span class="si">{</span><span class="n">round_filtered</span><span class="si">}</span><span class="s2">, Funding amount: </span><span class="si">{</span><span class="n">funding_filtered</span><span class="si">}</span><span class="s2">, Team size: </span><span class="si">{</span><span class="n">team_size_filtered</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="p">)</span>
</code></pre></div>
<p>This transparency allows monitoring of filter effectiveness and adjustment of criteria over time.</p>
<p><strong>6. Update Signals</strong> (<code>update_signals_in_db</code>)</p>
<p>Signals are updated with the IDs of companies that passed filtering:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">updated_signal</span> <span class="ow">in</span> <span class="n">updated_signals</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">update_signal</span><span class="p">(</span><span class="n">updated_signal</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;source_company_ids&quot;</span><span class="p">:</span> <span class="n">updated_signal</span><span class="o">.</span><span class="n">source_company_ids</span><span class="p">})</span>
</code></pre></div>
<p>The <code>source_company_ids</code> field transitions from <code>NULL</code> (unenriched) to a list of Harmonic company IDs (enriched and filtered). This:
- Marks the signal as fully processed
- Links the signal to specific companies in the database
- Enables traceability: "Which signals produced this company?"</p>
<p><strong>7. Store Companies</strong> (<code>store_companies_from_signals_in_db</code>, <code>store_companies_metrics_from_signals_in_db</code>)</p>
<p>Companies and their metrics are bulk-inserted into the database:</p>
<p><strong>Company Records</strong>:
<div class="highlight"><pre><span></span><code><span class="n">companies</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Company</span><span class="p">(</span>
        <span class="n">signal_id</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">signal_id</span><span class="p">,</span>
        <span class="n">source_company_id</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>  <span class="c1"># Harmonic&#39;s ID</span>
        <span class="n">name</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">legal_name</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">legal_name</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
        <span class="n">contact</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">contact</span><span class="p">,</span>
        <span class="n">founding_date</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">founding_date</span><span class="p">,</span>
        <span class="n">website_urls</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">website</span><span class="p">,</span>
        <span class="n">logo_url</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">logo_url</span><span class="p">,</span>
        <span class="n">ownership_status</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">ownership_status</span><span class="p">,</span>
        <span class="n">location</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
        <span class="n">tags</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span>
        <span class="n">socials</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">socials</span><span class="p">,</span>
        <span class="c1"># ... additional attributes</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">company</span> <span class="ow">in</span> <span class="n">filtered_companies</span>
<span class="p">]</span>
<span class="n">db</span><span class="o">.</span><span class="n">bulk_insert_rows</span><span class="p">(</span><span class="n">companies</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>Company Metrics</strong> (stored in separate table for time-series tracking):
<div class="highlight"><pre><span></span><code><span class="n">company_metrics</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">CompanyMetric</span><span class="p">(</span>
        <span class="n">company_id</span><span class="o">=</span><span class="n">inserted_company</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>  <span class="c1"># Foreign key to Company</span>
        <span class="n">stage</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">stage</span><span class="p">,</span>
        <span class="n">headcount</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">headcount</span><span class="p">,</span>
        <span class="n">traction_metrics</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">traction_metrics</span><span class="p">,</span>
        <span class="n">funding</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">funding</span><span class="p">,</span>
        <span class="n">employees</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">people</span><span class="p">,</span>
        <span class="n">highlights</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">highlights</span><span class="p">,</span>
        <span class="n">employee_highlights</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">employee_highlights</span><span class="p">,</span>
        <span class="n">investor_urn</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">investor_urn</span><span class="p">,</span>
        <span class="n">funding_rounds</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">funding_rounds</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">inserted_company</span><span class="p">,</span> <span class="n">company</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inserted_companies</span><span class="p">,</span> <span class="n">filtered_companies</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">db</span><span class="o">.</span><span class="n">bulk_insert_rows</span><span class="p">(</span><span class="n">company_metrics</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>Why separate tables</strong>: The <code>Company</code> table contains static attributes (name, description, founding date), while <code>CompanyMetric</code> contains time-varying metrics (funding, headcount, web traffic). This separation supports historical tracking—future ingestion runs can create new <code>CompanyMetric</code> records to track company growth over time.</p>
<p><strong>8. Add to Watchlist</strong> (<code>add_to_watchlist</code>)</p>
<p>Filtered companies are added to the source-specific Harmonic watchlist:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@op</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_to_watchlist</span><span class="p">(</span><span class="n">harmonic</span><span class="p">:</span> <span class="n">HarmonicResource</span><span class="p">,</span> <span class="n">watchlist</span><span class="p">:</span> <span class="n">Watchlist</span><span class="p">,</span> 
                     <span class="n">filtered_companies</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CompanyWithSignalId</span><span class="p">]):</span>
    <span class="n">company_urns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;urn:harmonic:company:</span><span class="si">{</span><span class="n">company</span><span class="o">.</span><span class="n">source_company_id</span><span class="si">}</span><span class="s2">&quot;</span> 
                    <span class="k">for</span> <span class="n">company</span> <span class="ow">in</span> <span class="n">filtered_companies</span><span class="p">]</span>

    <span class="n">harmonic</span><span class="o">.</span><span class="n">add_company_to_watchlist_by_urls</span><span class="p">(</span>
        <span class="n">watchlist_id</span><span class="o">=</span><span class="n">watchlist</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">company_urns</span><span class="o">=</span><span class="n">company_urns</span>
    <span class="p">)</span>
</code></pre></div>
<p>This enables ongoing monitoring within Harmonic's platform—companies tracked by OMVision automatically appear in the investment team's Harmonic workspace for deeper research.</p>
<hr />
<h4 id="people-enrichment-workflow">People Enrichment Workflow<a class="headerlink" href="#people-enrichment-workflow" title="Permanent link">&para;</a></h4>
<p>The <code>ingest_people_from_signals</code> job mirrors the company enrichment flow but processes people entities:</p>
<p><strong>1. Fetch Signals</strong>: Queries signals where <code>source_people_ids</code> is NULL</p>
<p><strong>2-3. Skip Search/Parse</strong>: People enrichment does not include a name search phase. It proceeds directly to URL enrichment because people are identified by LinkedIn URLs rather than names (to avoid ambiguity).</p>
<p><strong>4. Enrich by LinkedIn URL</strong> (<code>enrich_people_with_harmonic</code>):</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">signal</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
    <span class="n">enriched_people</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">person_name</span><span class="p">,</span> <span class="n">person_url</span> <span class="ow">in</span> <span class="n">signal</span><span class="o">.</span><span class="n">ner_tags</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">person_url</span> <span class="ow">and</span> <span class="s2">&quot;linkedin.com/in&quot;</span> <span class="ow">in</span> <span class="n">person_url</span><span class="p">:</span>
            <span class="n">enriched_person</span> <span class="o">=</span> <span class="n">harmonic</span><span class="o">.</span><span class="n">enrich_people</span><span class="p">(</span><span class="s2">&quot;linkedin_url&quot;</span><span class="p">,</span> <span class="n">person_url</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">enriched_person</span><span class="p">:</span>
                <span class="n">enriched_people</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">enriched_person</span><span class="p">)</span>
</code></pre></div>
<p><strong><code>enrich_people</code> method</strong>:
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">enrich_people</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">identifier_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PeopleBase</span><span class="p">]:</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">identifier_type</span><span class="p">:</span> <span class="n">identifier_value</span><span class="p">}</span>  <span class="c1"># {&quot;linkedin_url&quot;: &quot;https://linkedin.com/in/...&quot;}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span><span class="si">}</span><span class="s2">people&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_headers</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">PeopleBase</span><span class="p">(</span><span class="o">**</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</code></pre></div></p>
<p>Returns:</p>
<ul>
<li><strong>Core attributes</strong>: first_name, last_name, headline, location, LinkedIn URL</li>
<li><strong>Experience</strong>: List of work history with company, title, duration</li>
<li><strong>Education</strong>: Degrees, institutions, fields of study</li>
<li><strong>Highlights</strong>: Skills, certifications, notable achievements</li>
<li><strong>Network</strong>: Mutual connections, if available</li>
</ul>
<p><strong>5. Filter People</strong>: People filtering applies location-based criteria:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="n">location</span><span class="p">:</span>
    <span class="n">country</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;country&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">country</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">LOCATION_FILTER_LIST</span><span class="p">:</span>
        <span class="k">continue</span>  <span class="c1"># Exclude</span>
</code></pre></div>
<p>Unlike companies, people are not filtered by funding stage or headcount (those are company attributes).</p>
<p><strong>6. Update Signals</strong>: Sets <code>source_people_ids</code> on signals</p>
<p><strong>7. Store People</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="n">people</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Person</span><span class="p">(</span>
        <span class="n">signal_id</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">signal_id</span><span class="p">,</span>
        <span class="n">source_person_id</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>  <span class="c1"># Harmonic&#39;s ID</span>
        <span class="n">first_name</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
        <span class="n">last_name</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span>
        <span class="n">headline</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">headline</span><span class="p">,</span>
        <span class="n">location</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
        <span class="n">linkedin_url</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">linkedin_url</span><span class="p">,</span>
        <span class="n">experience</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">experience</span><span class="p">,</span>
        <span class="n">education</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">education</span><span class="p">,</span>
        <span class="n">highlights</span><span class="o">=</span><span class="n">person</span><span class="o">.</span><span class="n">highlights</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">filtered_people</span>
<span class="p">]</span>
<span class="n">db</span><span class="o">.</span><span class="n">bulk_insert_rows</span><span class="p">(</span><span class="n">people</span><span class="p">)</span>
</code></pre></div>
<p><strong>8. Add to People Watchlist</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="n">harmonic</span><span class="o">.</span><span class="n">add_people_to_watchlist</span><span class="p">(</span>
    <span class="n">watchlist_id</span><span class="o">=</span><span class="n">watchlist</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
    <span class="n">people_urns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;urn:harmonic:person:</span><span class="si">{</span><span class="n">person</span><span class="o">.</span><span class="n">source_person_id</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="n">filtered_people</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>
<hr />
<h3 id="324-classification">3.2.4 Classification<a class="headerlink" href="#324-classification" title="Permanent link">&para;</a></h3>
<p>Classification assigns a relevance rank to each company, enabling prioritization in the user interface. This stage uses a machine learning model trained on historical feedback to predict which companies are most likely to be investment-worthy based on both quantitative metrics (funding, headcount, web traffic) and qualitative features (company description, highlights, tags).</p>
<p>The <code>classify_ingested_companies</code> job (<code>app/jobs/classify_ingested_companies.py</code>) processes unclassified companies through a seven-step feature engineering and prediction pipeline:</p>
<p><strong>1. Fetch Unclassified Companies</strong> (<code>get_all_unclassified_companies</code>)</p>
<p>Queries the database for companies where the <code>rank</code> field is NULL:</p>
<div class="highlight"><pre><span></span><code><span class="n">companies</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">fetch_unclassified_companies</span><span class="p">()</span>
</code></pre></div>
<p>Each company is split into two feature sets:</p>
<p><strong>Natural Language Features</strong> (<code>CompanyNLFeatures</code>):</p>
<ul>
<li><code>description</code>: Company description text</li>
<li><code>tags</code>: Industry/category tags from Harmonic</li>
<li><code>highlights</code>: Company highlights (partnerships, products, milestones)</li>
<li><code>employee_highlights</code>: Notable employee backgrounds (former employers, skills)</li>
</ul>
<p><strong>Numerical/Categorical Features</strong> (<code>CompanyOtherFeatures</code>):</p>
<ul>
<li><code>last_funding_type</code>: Most recent funding round (e.g., "SEED", "SERIES_A")</li>
<li><code>country</code>: Company location</li>
<li><code>stage</code>: Funding stage</li>
<li><code>headcount</code>: Number of employees</li>
<li><code>funding_total</code>: Total capital raised</li>
<li><code>last_funding_date</code>: Date of most recent funding</li>
<li><code>founding_date</code>: Company founding date</li>
<li><code>number_of_funding_rounds</code>: Total funding events</li>
<li><code>web_traffic_change</code>: 90-day percent change in website traffic</li>
</ul>
<p><strong>2. Format NL Features</strong> (<code>format_company_nl_features</code>)</p>
<p>Transforms raw JSON structures into concatenated strings suitable for LLM processing:</p>
<p><strong>Tags Formatting</strong>:
<div class="highlight"><pre><span></span><code><span class="n">tags_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
    <span class="n">display_value</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;display_value&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">tag_type</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">display_value</span> <span class="ow">and</span> <span class="n">tag_type</span><span class="p">:</span>
        <span class="n">tags_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">display_value</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">tag_type</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="n">tags_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">tags_set</span><span class="p">))</span>
<span class="c1"># Example output: &quot;Healthcare (industry), B2B (business_model), SaaS (product_type)&quot;</span>
</code></pre></div></p>
<p><strong>Highlights Formatting</strong>:
<div class="highlight"><pre><span></span><code><span class="n">company_highlights_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">company_highlights</span><span class="p">:</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">category</span> <span class="ow">and</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">company_highlights_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">company_highlights_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">company_highlights_list</span><span class="p">)</span>
<span class="c1"># Example output:</span>
<span class="c1"># &quot;Partnership: Collaboration with Mayo Clinic for diagnostic trials</span>
<span class="c1"># Product: Launched AI-powered imaging platform in Q2 2024&quot;</span>
</code></pre></div></p>
<p><strong>Employee Highlights Formatting</strong> (with summarization):
<div class="highlight"><pre><span></span><code><span class="n">category_counts</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">employee_highlights</span><span class="p">:</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">category</span><span class="p">:</span>
        <span class="n">category_counts</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="n">category_counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">summary_lines</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> employees with &#39;</span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s2">&#39;&quot;</span> 
                 <span class="k">for</span> <span class="n">category</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">category_counts</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
<span class="n">summary_str</span> <span class="o">=</span> <span class="s2">&quot;Employee Highlights Summary:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary_lines</span><span class="p">)</span>

<span class="n">employee_highlights_str</span> <span class="o">=</span> <span class="n">summary_str</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">individual_highlights</span><span class="p">)</span>
<span class="c1"># Example output:</span>
<span class="c1"># &quot;Employee Highlights Summary:</span>
<span class="c1"># 3 employees with &#39;Former FAANG&#39;</span>
<span class="c1"># 2 employees with &#39;PhD&#39;</span>
<span class="c1">#</span>
<span class="c1"># Former FAANG: Worked at Google for 5 years as Senior Engineer</span>
<span class="c1"># PhD: Stanford PhD in Computer Vision&quot;</span>
</code></pre></div></p>
<p><strong>3. Extract Numerical Features from NL</strong> (<code>extract_numerical_features_from_nl</code>)</p>
<p>Uses OpenAI <code>gpt-4o-2024-08-06</code> to transform natural language features into numerical ratings. For each company, the LLM is prompted to score four dimensions:</p>
<p><strong>Transformation Prompt</strong> (defined in <code>app/resources/open_ai.py</code>):</p>
<div class="highlight"><pre><span></span><code>You are a venture capital analyst. Given a company&#39;s description, highlights, tags, and employee 
highlights, rate the company on the following dimensions using a scale of 0-10:

1. company_relevance: How relevant is this company to early-stage venture investment? 
   (0 = completely irrelevant, 10 = highly relevant startup)

2. founder_strength: How strong is the founding team based on their backgrounds? 
   (0 = weak/unknown, 10 = exceptional pedigree)

3. investor_relevance: How notable are the company&#39;s investors? 
   (0 = no notable investors, 10 = top-tier VCs)

4. team_strength: How strong is the overall team composition? 
   (0 = weak team, 10 = exceptional team)

Company information:
- Description: {description}
- Tags: {tags}
- Highlights: {highlights}
- Employee Highlights: {employee_highlights}

Return your ratings as a JSON object with keys: company_relevance, founder_strength, 
investor_relevance, team_strength
</code></pre></div>
<p><strong>Example Input</strong>:
<div class="highlight"><pre><span></span><code>Description: DeepTech develops AI-powered diagnostic imaging tools for early cancer detection. 
Our platform analyzes medical scans 10x faster than traditional methods.

Tags: Healthcare (industry), B2B (business_model), SaaS (product_type)

Highlights:
Partnership: Collaboration with Mayo Clinic for diagnostic trials
Product: Launched AI-powered imaging platform in Q2 2024

Employee Highlights Summary:
3 employees with &#39;Former FAANG&#39;
2 employees with &#39;PhD&#39;

Former FAANG: Worked at Google for 5 years as Senior Engineer
PhD: Stanford PhD in Computer Vision
</code></pre></div></p>
<p><strong>Example Output</strong>:
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;company_relevance&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;founder_strength&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;investor_relevance&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;team_strength&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">9</span>
<span class="p">}</span>
</code></pre></div></p>
<p>These scores are stored as <code>CompanyExtractedRatingFeatures</code> alongside the company ID.</p>
<p><strong>4. Prepare Input DataFrame</strong> (<code>prepare_input_dataframe</code>)</p>
<p>Merges the LLM-generated ratings with the numerical/categorical features into a single pandas DataFrame:</p>
<div class="highlight"><pre><span></span><code><span class="n">df_transformed</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">extracted_numerical_features</span><span class="p">)</span>  <span class="c1"># LLM scores</span>
<span class="n">df_other</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">other_features</span><span class="p">)</span>                      <span class="c1"># Raw metrics</span>

<span class="n">df_all</span> <span class="o">=</span> <span class="n">df_transformed</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_other</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
</code></pre></div>
<p><strong>Resulting DataFrame schema</strong>:
<div class="highlight"><pre><span></span><code>| id | company_relevance | founder_strength | investor_relevance | team_strength | 
| last_funding_type | country | stage | headcount | funding_total | last_funding_date | 
| founding_date | number_of_funding_rounds | web_traffic_change |
</code></pre></div></p>
<p><strong>5. Preprocess Features</strong> (<code>preprocess_input_features</code>)</p>
<p>Applies feature engineering and handles missing data:</p>
<p><strong>Date Transformations</strong>:
<div class="highlight"><pre><span></span><code><span class="c1"># Convert to datetime</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;last_funding_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;last_funding_date&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;founding_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;founding_date&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># Derive temporal features</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;days_since_funding&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;today&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;last_funding_date&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;company_age&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s2">&quot;today&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;founding_date&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

<span class="c1"># Drop original date columns</span>
<span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;last_funding_date&quot;</span><span class="p">,</span> <span class="s2">&quot;founding_date&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>Missing Value Imputation</strong>:
<div class="highlight"><pre><span></span><code><span class="n">df</span><span class="p">[</span><span class="s2">&quot;headcount&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;funding_total&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;last_funding_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;UNKNOWN&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;UNKNOWN&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;UNKNOWN&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;web_traffic_change&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;number_of_funding_rounds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>Categorical Encoding</strong>:
<div class="highlight"><pre><span></span><code><span class="c1"># Apply predefined mappings</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;last_funding_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;last_funding_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">FUNDING_TYPE_MAPPING</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stage&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">STAGE_MAPPING</span><span class="p">)</span>

<span class="c1"># Label encode country</span>
<span class="n">le</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">le</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;country&quot;</span><span class="p">])</span>
</code></pre></div></p>
<p><strong>Normalization</strong> (MinMax scaling):
<div class="highlight"><pre><span></span><code><span class="n">numerical_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
<span class="n">numerical_columns</span> <span class="o">=</span> <span class="n">numerical_columns</span><span class="o">.</span><span class="n">difference</span><span class="p">([</span><span class="s2">&quot;country&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">])</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="n">numerical_columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">numerical_columns</span><span class="p">])</span>
</code></pre></div></p>
<p><strong>Handling Companies with Missing Critical Data</strong>:</p>
<p>Companies missing temporal features (founding_date, last_funding_date) are split into a separate DataFrame (<code>df_dropped</code>) containing only the four LLM-generated NL features. These will be classified using a secondary model trained exclusively on NL features.</p>
<div class="highlight"><pre><span></span><code><span class="n">df_cleaned</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>  <span class="c1"># Companies with all features → primary model</span>
<span class="n">df_dropped</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)][[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;company_relevance&quot;</span><span class="p">,</span> <span class="s2">&quot;founder_strength&quot;</span><span class="p">,</span> 
                                         <span class="s2">&quot;investor_relevance&quot;</span><span class="p">,</span> <span class="s2">&quot;team_strength&quot;</span><span class="p">]]</span>  <span class="c1"># NL-only → secondary model</span>
</code></pre></div>
<p><strong>6. Classify Companies</strong></p>
<p>Two classification operations run in parallel:</p>
<p><strong>Primary Classification</strong> (<code>get_primary_company_classes</code>):</p>
<p>Uses the full feature set (NL scores + metrics):</p>
<div class="highlight"><pre><span></span><code><span class="nd">@op</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_primary_company_classes</span><span class="p">(</span><span class="n">df_input</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">ml</span><span class="p">:</span> <span class="n">MLResource</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">CompanyClassification</span><span class="p">]:</span>
    <span class="n">company_ids</span> <span class="o">=</span> <span class="n">df_input</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">df_input</span> <span class="o">=</span> <span class="n">df_input</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">predictions</span> <span class="o">=</span> <span class="n">ml</span><span class="o">.</span><span class="n">primary_classify_companies</span><span class="p">(</span><span class="n">df_input</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">CompanyClassification</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">cid</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">pred</span><span class="p">)</span> 
            <span class="k">for</span> <span class="n">cid</span><span class="p">,</span> <span class="n">pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">company_ids</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)]</span>
</code></pre></div>
<p><strong>Inside <code>MLResource.primary_classify_companies</code></strong> (<code>app/resources/ml_model.py</code>):</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">primary_classify_companies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">companies</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;app/constants/lightgbm_model.pkl&quot;</span><span class="p">)</span>
    <span class="n">y_pred_prob</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">companies</span><span class="p">,</span> <span class="n">num_iteration</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">best_iteration</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred_prob</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Ordinal class: 0, 1, 2, 3, 4</span>
    <span class="k">return</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</code></pre></div>
<p><strong>Secondary Classification</strong> (<code>get_secondary_company_classes</code>):</p>
<p>Uses only NL features for companies missing metrics:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">secondary_classify_companies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">companies</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;app/constants/lightgbm_nan_model.pkl&quot;</span><span class="p">)</span>
    <span class="n">y_pred_prob</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">companies</span><span class="p">,</span> <span class="n">num_iteration</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">best_iteration</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_pred_prob</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</code></pre></div>
<p><strong>Model Architecture</strong>:</p>
<p>OMVision uses an <strong>ordinal classifier</strong> wrapping a LightGBM gradient boosting model. Ordinal classification treats rank as an ordered categorical variable (0 &lt; 1 &lt; 2 &lt; 3 &lt; 4) rather than arbitrary classes, improving prediction accuracy for inherently ranked targets.</p>
<p><strong>Rank meanings</strong> (inferred from use):</p>
<ul>
<li><strong>0</strong>: Very low relevance (likely filtered out in UI)</li>
<li><strong>1</strong>: Low relevance</li>
<li><strong>2</strong>: Moderate relevance</li>
<li><strong>3</strong>: High relevance (worth investigation)</li>
<li><strong>4</strong>: Very high relevance (priority review)</li>
</ul>
<p>The model was trained on historical company classifications labeled by the investment team, learning patterns that correlate features with investment attractiveness.</p>
<p><strong>7. Update Database</strong> (<code>update_company_classes_in_db</code>)</p>
<p>Predicted ranks are bulk-updated in the database:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">classification</span> <span class="ow">in</span> <span class="n">all_classifications</span><span class="p">:</span>  <span class="c1"># primary + secondary</span>
    <span class="n">db</span><span class="o">.</span><span class="n">update_company</span><span class="p">(</span><span class="n">classification</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;rank&quot;</span><span class="p">:</span> <span class="n">classification</span><span class="o">.</span><span class="n">rank</span><span class="p">})</span>
</code></pre></div>
<p>Companies now have a <code>rank</code> value, enabling the frontend UI to sort and filter by predicted relevance.</p>
<hr />
<h3 id="325-persistence">3.2.5 Persistence<a class="headerlink" href="#325-persistence" title="Permanent link">&para;</a></h3>
<p>The final stage synchronizes frontend custom column data (user-generated metadata) with backend storage. Users interact with OMVision's UI to tag companies and people with custom attributes—comments, relevance stage, visibility flags, and list memberships. These annotations must be persisted to the database to maintain consistency across sessions and team members.</p>
<h4 id="why-this-workflow-exists">Why This Workflow Exists<a class="headerlink" href="#why-this-workflow-exists" title="Permanent link">&para;</a></h4>
<p>The OMVision frontend (built with React/Supabase) allows users to:</p>
<ul>
<li><strong>Rank companies manually</strong>: Override ML-predicted ranks with human judgment</li>
<li><strong>Tag relevance stage</strong>: "In Review", "Passed", "Declined", "Portfolio"</li>
<li><strong>Add comments</strong>: Internal notes about due diligence, call outcomes, thesis fit</li>
<li><strong>Hide entities</strong>: Mark companies/people as irrelevant without deleting (preserves audit trail)</li>
<li><strong>Assign to lists</strong>: Organize entities into thematic lists ("Q4 Targets", "Healthcare Focus", etc.)</li>
</ul>
<p>These custom columns are initially stored in Supabase (the frontend database) but must be synchronized to the PostgreSQL backend (the source of truth for Dagster jobs) to ensure:</p>
<ol>
<li><strong>Data consistency</strong>: Same entity viewed in UI and Dagster has identical metadata</li>
<li><strong>Auditability</strong>: All user interactions are logged in the backend</li>
<li><strong>Cross-functional access</strong>: Investment team annotations are visible to data/engineering teams for model retraining</li>
</ol>
<h4 id="persistence-workflow">Persistence Workflow<a class="headerlink" href="#persistence-workflow" title="Permanent link">&para;</a></h4>
<p>The <code>persist_custom_columns_data</code> job (<code>app/jobs/persist_custom_columns_data.py</code>) runs daily (scheduled at 6:00 PM UTC) to sync frontend data with the backend.</p>
<p><strong>Company Custom Columns Workflow</strong>:</p>
<p><strong>1. Fetch Today's Ingested Companies</strong> (<code>get_companies_to_harmonise</code>)</p>
<p>Retrieves companies ingested in the past 24 hours:</p>
<div class="highlight"><pre><span></span><code><span class="n">companies</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">fetch_ingested_companies_for_today</span><span class="p">()</span>
<span class="n">ingested_companies</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">CompanyCustomColumns</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">source_company_id</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">source_company_id</span><span class="p">,</span>  <span class="c1"># Harmonic ID</span>
        <span class="n">rank</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span>
        <span class="n">relevence_stage</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">relevence_stage</span><span class="p">,</span>
        <span class="n">comments</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">comments</span><span class="p">,</span>
        <span class="n">is_hidden</span><span class="o">=</span><span class="n">company</span><span class="o">.</span><span class="n">is_hidden</span><span class="p">,</span>
        <span class="n">list_ids</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">company</span> <span class="ow">in</span> <span class="n">companies</span>
<span class="p">]</span>
</code></pre></div>
<p><strong>2. Fetch Custom Column Data from Frontend</strong> (<code>get_custom_columns_data</code>)</p>
<p>Queries Supabase (via the backend database) for matching companies by <code>name</code> and <code>source_company_id</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">custom_column_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">fetch_custom_columns_by_company_name_and_source_company_id</span><span class="p">(</span><span class="n">ingested_companies</span><span class="p">)</span>

<span class="n">custom_columns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">CompanyCustomColumns</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">source_company_id</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">source_company_id</span><span class="p">,</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>  <span class="c1"># Backend ID</span>
        <span class="n">rank</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span>
        <span class="n">relevence_stage</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">relevence_stage</span><span class="p">,</span>
        <span class="n">comments</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">comments</span><span class="p">,</span>
        <span class="n">is_hidden</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">is_hidden</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">custom_column_data</span>
<span class="p">]</span>
</code></pre></div>
<p><strong>3. Fetch List Memberships</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="n">lists_data</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">fetch_list_by_company_name_and_source_company_id</span><span class="p">(</span><span class="n">ingested_companies</span><span class="p">)</span>

<span class="n">aggregated_data</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">source_company_id</span><span class="p">,</span> <span class="n">list_id</span> <span class="ow">in</span> <span class="n">lists_data</span><span class="p">:</span>
    <span class="n">aggregated_data</span><span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="n">source_company_id</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">list_id</span><span class="p">)</span>

<span class="n">lists</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">CompanyCustomColumns</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">source_company_id</span><span class="o">=</span><span class="n">source_company_id</span><span class="p">,</span>
        <span class="n">list_ids</span><span class="o">=</span><span class="n">list_ids</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">source_company_id</span><span class="p">),</span> <span class="n">list_ids</span> <span class="ow">in</span> <span class="n">aggregated_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">]</span>
</code></pre></div>
<p><strong>4. Update Custom Columns</strong> (<code>update_custom_columns</code>)</p>
<p>For each newly ingested company, checks if it already exists in the frontend database (matched by <code>name</code> and <code>source_company_id</code>). If so, copies the frontend's custom column values to the backend:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">ingested_company</span> <span class="ow">in</span> <span class="n">ingested_companies</span><span class="p">:</span>
    <span class="n">matching_company</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
        <span class="p">(</span><span class="n">data</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">custom_columns</span>
         <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ingested_company</span><span class="o">.</span><span class="n">name</span>
         <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">source_company_id</span> <span class="o">==</span> <span class="n">ingested_company</span><span class="o">.</span><span class="n">source_company_id</span><span class="p">),</span>
        <span class="kc">None</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">matching_company</span><span class="p">:</span>
        <span class="n">update_fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">matching_company</span><span class="o">.</span><span class="n">rank</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ingested_company</span><span class="o">.</span><span class="n">rank</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_fields</span><span class="p">[</span><span class="s2">&quot;rank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matching_company</span><span class="o">.</span><span class="n">rank</span>
        <span class="k">if</span> <span class="n">matching_company</span><span class="o">.</span><span class="n">relevence_stage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_fields</span><span class="p">[</span><span class="s2">&quot;relevence_stage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matching_company</span><span class="o">.</span><span class="n">relevence_stage</span>
        <span class="k">if</span> <span class="n">matching_company</span><span class="o">.</span><span class="n">comments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_fields</span><span class="p">[</span><span class="s2">&quot;comments&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matching_company</span><span class="o">.</span><span class="n">comments</span>
        <span class="k">if</span> <span class="n">matching_company</span><span class="o">.</span><span class="n">is_hidden</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_fields</span><span class="p">[</span><span class="s2">&quot;is_hidden&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matching_company</span><span class="o">.</span><span class="n">is_hidden</span>

        <span class="k">if</span> <span class="n">update_fields</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">update_company</span><span class="p">(</span><span class="n">ingested_company</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">update_fields</span><span class="p">)</span>
</code></pre></div>
<p><strong>Logic</strong>: Only non-NULL frontend values overwrite backend values. This preserves backend defaults (e.g., ML-predicted rank) unless explicitly overridden in the UI.</p>
<p><strong>5. Update List Memberships</strong> (<code>update_lists</code>)</p>
<p>Associates companies with their lists:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">ingested_company</span> <span class="ow">in</span> <span class="n">ingested_companies</span><span class="p">:</span>
    <span class="n">matching_lists</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
        <span class="p">(</span><span class="n">data</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">lists</span>
         <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ingested_company</span><span class="o">.</span><span class="n">name</span>
         <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">source_company_id</span> <span class="o">==</span> <span class="n">ingested_company</span><span class="o">.</span><span class="n">source_company_id</span><span class="p">),</span>
        <span class="kc">None</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">matching_lists</span> <span class="ow">and</span> <span class="n">matching_lists</span><span class="o">.</span><span class="n">list_ids</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">list_id</span> <span class="ow">in</span> <span class="n">matching_lists</span><span class="o">.</span><span class="n">list_ids</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">add_company_to_list</span><span class="p">(</span><span class="n">ingested_company</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">list_id</span><span class="p">)</span>
</code></pre></div>
<p>This creates <code>ListEntityAssociation</code> records linking companies to lists.</p>
<hr />
<p><strong>People Custom Columns Workflow</strong>:</p>
<p>The people workflow (<code>get_people_to_harmonise</code>, <code>get_custom_columns_data_for_people</code>, <code>update_custom_columns_for_people</code>, <code>update_lists_for_people</code>) mirrors the company flow but operates on <code>Person</code> records. The logic is identical: match by <code>first_name</code>, <code>last_name</code>, and <code>source_person_id</code>, then copy custom columns and list memberships from frontend to backend.</p>
<hr />
<h4 id="data-flow-summary">Data Flow Summary<a class="headerlink" href="#data-flow-summary" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>Frontend (Supabase)                    Backend (PostgreSQL)
    │                                       │
    │  User tags company                    │
    │  - Rank: 4                            │
    │  - Stage: &quot;In Review&quot;                 │
    │  - Comment: &quot;Strong founder&quot;          │
    │  - Lists: [&quot;Q4 Targets&quot;]              │
    │                                       │
    └──────────── 6:00 PM UTC ─────────────▶│
                                            │
                persist_custom_columns_data │
                                            │
                1. Fetch today&#39;s companies  │
                2. Query frontend for       │
                   matching entities        │
                3. Copy custom columns      │
                4. Associate with lists     │
                                            │
                Backend now has frontend    │
                annotations                 │
                                            │
        ┌───────────────────────────────────┘
        │
        ▼
    Dagster jobs see
    updated metadata
    (for model retraining,
    reporting, etc.)
</code></pre></div>
<p><strong>Why Daily Sync</strong>: The job runs after the classification job (6:30 PM) to ensure newly classified companies immediately receive any pre-existing annotations from the frontend. This prevents data loss if a company is re-ingested or if team members tagged the company in Harmonic's UI before it reached OMVision.</p>
<hr />
<h2 id="33-job-dependencies">3.3 Job Dependencies<a class="headerlink" href="#33-job-dependencies" title="Permanent link">&para;</a></h2>
<p>OMVision's jobs form a directed acyclic graph (DAG) where downstream jobs depend on upstream outputs. Understanding these dependencies is critical for debugging, optimizing schedules, and extending the pipeline.</p>
<pre class="mermaid"><code>graph TB
    subgraph "Daily Schedule (3:00 PM UTC)"
        A1[ingest_signals_from_accern]
        A2[ingest_signals_from_emails]
        A3[ingest_companies_from_searches]
        A4[ingest_people_from_searches]
    end

    subgraph "Triggered by Sensors"
        B1[ingest_companies_from_signals]
        B2[ingest_people_from_signals]
    end

    subgraph "Daily Schedule (6:00-6:30 PM UTC)"
        C1[persist_custom_columns_data]
        C2[classify_ingested_companies]
    end

    A1 --&gt;|SUCCESS sensor| B1
    A1 --&gt;|SUCCESS sensor| B2
    A2 --&gt;|SUCCESS sensor| B1
    A2 --&gt;|SUCCESS sensor| B2

    B1 -.-&gt;|data dependency| C2
    A3 -.-&gt;|data dependency| C2

    B1 -.-&gt;|data dependency| C1
    B2 -.-&gt;|data dependency| C1
    A3 -.-&gt;|data dependency| C1
    A4 -.-&gt;|data dependency| C1

    style A1 fill:#ffe6e6
    style A2 fill:#ffe6e6
    style A3 fill:#ffe6e6
    style A4 fill:#ffe6e6
    style B1 fill:#e6f3ff
    style B2 fill:#e6f3ff
    style C1 fill:#e6ffe6
    style C2 fill:#e6ffe6</code></pre>
<p><strong>Legend:</strong></p>
<ul>
<li><strong>Red nodes</strong>: Signal ingestion (scheduled)</li>
<li><strong>Blue nodes</strong>: Entity extraction (sensor-triggered)</li>
<li><strong>Green nodes</strong>: Post-processing (scheduled)</li>
<li><strong>Solid arrows</strong>: Direct triggers (sensors)</li>
<li><strong>Dashed arrows</strong>: Data dependencies (no direct trigger)</li>
</ul>
<p><strong>Dependency Chains:</strong></p>
<ol>
<li><strong>Accern → Entity Extraction → Classification</strong>:</li>
<li><code>ingest_signals_from_accern</code> stores signals with extracted entities</li>
<li>Sensor triggers <code>ingest_companies_from_signals</code>, which enriches and stores companies</li>
<li>
<p><code>classify_ingested_companies</code> (scheduled later) classifies those companies</p>
</li>
<li>
<p><strong>Harmonic Searches → Classification</strong>:</p>
</li>
<li><code>ingest_companies_from_searches</code> directly stores enriched companies</li>
<li>
<p><code>classify_ingested_companies</code> classifies them</p>
</li>
<li>
<p><strong>All Ingestion → Persistence</strong>:</p>
</li>
<li><code>persist_custom_columns_data</code> syncs metadata for all companies/people ingested today</li>
<li>Depends implicitly on all ingestion jobs completing first</li>
</ol>
<p><strong>Scheduling Rationale:</strong></p>
<ul>
<li><strong>3:00 PM</strong>: All ingestion jobs run concurrently (independent of each other)</li>
<li><strong>3:00-5:00 PM</strong>: Entity extraction completes (sensor-triggered)</li>
<li><strong>6:00 PM</strong>: Persistence runs (assumes extraction complete)</li>
<li><strong>6:30 PM</strong>: Classification runs (assumes new companies stored)</li>
</ul>
<p>This staggered timing provides buffer for upstream jobs to complete while avoiding race conditions.</p>
<hr />
<h2 id="34-signal-processing-jobs">3.4 Signal Processing Jobs<a class="headerlink" href="#34-signal-processing-jobs" title="Permanent link">&para;</a></h2>
<p>This section details the operational logic of jobs responsible for ingesting and storing raw signals.</p>
<h3 id="341-ingest_signals_from_accern">3.4.1 ingest_signals_from_accern<a class="headerlink" href="#341-ingest_signals_from_accern" title="Permanent link">&para;</a></h3>
<p><strong>Purpose:</strong> Fetch signals from Accern API, extract entities, enrich with URLs, filter, and store.</p>
<p><strong>Op Sequence:</strong></p>
<ol>
<li><code>accern_source()</code> → Returns asset <code>source_name="Accern"</code></li>
<li><code>fetch_source_from_db(source_name="Accern")</code> → Returns <code>DataSourceReturn</code></li>
<li><code>ingest_data_from_channels(source)</code> → Returns <code>list[AccernFeed]</code></li>
<li>Iterates source channels, calls <code>accern.fetch_feed(endpoint, token)</code></li>
<li><code>get_signals_from_feeds(feeds)</code> → Returns <code>list[AccernSignal]</code></li>
<li>Flattens feeds into signals</li>
<li><code>get_unique_context_from_signals(signals)</code> → Returns <code>(list[dict], list[AccernSignal])</code></li>
<li>Deduplicates by context tuple</li>
<li><code>get_entities_from_signals(contexts)</code> → Returns <code>(list[OpenAiNerTags], list[OpenAiNerTags])</code></li>
<li>Calls <code>openai.preprocess_text</code>, <code>openai.get_all_ner_tags</code>, <code>openai.filter_ner_tags</code> for each context</li>
<li><code>extract_entity_context_from_signals(contexts, entities)</code> → Returns <code>list[OpenAiSignalContext]</code></li>
<li>Calls <code>openai.extract_context_from_signal</code> for each</li>
<li><code>company_filter_list()</code> → Returns <code>list[str]</code> (asset)</li>
<li><code>enrich_companies_and_people(signal_contexts)</code> → Returns <code>list[NerTags]</code></li>
<li>Calls <code>google.match_or_fetch_company_url</code> and <code>google.match_or_fetch_linkedin_profile</code> for each entity</li>
<li><code>filter_entities(filter_list, entities)</code> → Returns <code>list[NerTags]</code></li>
<li><code>combine_signals_and_entities(source, signals, entities, raw_entities)</code> → Returns <code>list[SignalCreate]</code></li>
<li><code>store_in_db(signals)</code> → Inserts <code>Signal</code> records</li>
</ol>
<p><strong>Key Logic:</strong></p>
<ul>
<li><strong>Deduplication</strong>: Multiple signals may reference the same article/event; deduplication avoids redundant NER processing</li>
<li><strong>Raw vs. filtered entities</strong>: Both are stored to enable comparison and debugging</li>
<li><strong>URL enrichment happens here</strong>: Unlike direct searches, signals don't have URLs upfront</li>
</ul>
<p><strong>Sensor Trigger:</strong></p>
<p>Upon success, the <code>signal_ingestion_from_accern</code> sensor triggers:
- <code>ingest_companies_from_signals</code> (with <code>source_name="Accern"</code>)
- <code>ingest_people_from_signals</code> (with <code>source_name="Accern"</code>)</p>
<p><strong>Important Note</strong>: Even though we have a step called <code>enrich_companies_and_people(signal_contexts)</code>, we are not enriching companies with Harmonic data at this step. Enrichment in this job means finding the URL for the company. </p>
<h3 id="342-ingest_signals_from_emails">3.4.2 ingest_signals_from_emails<a class="headerlink" href="#342-ingest_signals_from_emails" title="Permanent link">&para;</a></h3>
<p><strong>Purpose:</strong> Fetch emails, extract entities, enrich, filter, and store.</p>
<p><strong>Op Sequence:</strong></p>
<ol>
<li><code>gmail_source()</code> → Returns asset <code>source_name="Gmail"</code></li>
<li><code>fetch_source_from_db(source_name="Gmail")</code> → Returns <code>DataSourceReturn</code></li>
<li><code>fetch_emails()</code> → Returns <code>list[MailMessage]</code></li>
<li>Calls <code>gmail.get_emails()</code></li>
<li><code>get_context_from_emails(emails)</code> → Returns <code>list[str]</code></li>
<li>Extracts email body text</li>
<li><code>get_entities_from_emails(email_bodies)</code> → Returns <code>(list[OpenAiNerTags], list[OpenAiNerTags])</code></li>
<li>Same NER flow as Accern but with <code>vanilla_prompt=True</code></li>
<li><code>extract_entity_context_from_emails(bodies, entities)</code> → Returns <code>list[OpenAiSignalContext]</code></li>
<li><code>company_filter_list()</code> → Returns <code>list[str]</code></li>
<li><code>enrich_companies_and_people(signal_contexts)</code> → Returns <code>list[NerTags]</code></li>
<li><code>filter_entities(filter_list, entities)</code> → Returns <code>list[NerTags]</code></li>
<li><code>combine_emails_and_entities(source, emails, entities, raw_entities)</code> → Returns <code>list[SignalCreate]</code></li>
<li><code>store_email_signals_in_db(signals)</code> → Inserts <code>Signal</code> records</li>
</ol>
<p><strong>Difference from Accern:</strong></p>
<ul>
<li>No feed structure; each email is a single signal</li>
<li>No deduplication step</li>
<li>Uses vanilla OpenAI prompt (no Accern metadata)</li>
</ul>
<p><strong>Sensor Trigger:</strong></p>
<p>Upon success, the <code>signal_ingestion_from_emails</code> sensor triggers:</p>
<ul>
<li><code>ingest_companies_from_signals</code> (with <code>source_name="Gmail"</code>)</li>
<li><code>ingest_people_from_signals</code> (with <code>source_name="Gmail"</code>)</li>
</ul>
<h3 id="343-signal-sensors">3.4.3 Signal Sensors<a class="headerlink" href="#343-signal-sensors" title="Permanent link">&para;</a></h3>
<p><strong>Architecture:</strong></p>
<p>Run status sensors monitor specific jobs and trigger downstream jobs upon successful completion. They implement the <strong>observer pattern</strong> in distributed orchestration.</p>
<p><strong><code>signal_ingestion_from_accern</code> Sensor:</strong></p>
<div class="highlight"><pre><span></span><code><span class="nd">@run_status_sensor</span><span class="p">(</span>
    <span class="n">run_status</span><span class="o">=</span><span class="n">DagsterRunStatus</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span>
    <span class="n">monitored_jobs</span><span class="o">=</span><span class="p">[</span><span class="n">ingest_signals_from_accern</span><span class="p">],</span>
    <span class="n">request_jobs</span><span class="o">=</span><span class="p">[</span><span class="n">ingest_companies_from_signals</span><span class="p">,</span> <span class="n">ingest_people_from_signals</span><span class="p">],</span>
    <span class="n">minimum_interval_seconds</span><span class="o">=</span><span class="mi">7200</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">signal_ingestion_from_accern</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="n">company_op</span> <span class="o">=</span> <span class="n">get_op_config</span><span class="p">(</span><span class="s2">&quot;Accern&quot;</span><span class="p">)</span>
    <span class="n">people_op</span> <span class="o">=</span> <span class="n">get_op_config</span><span class="p">(</span><span class="s2">&quot;Accern&quot;</span><span class="p">,</span> <span class="n">PipelineType</span><span class="o">.</span><span class="n">people</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">RunRequest</span><span class="p">(</span>
        <span class="n">job_name</span><span class="o">=</span><span class="s2">&quot;ingest_companies_from_signals&quot;</span><span class="p">,</span>
        <span class="n">run_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">run_config</span><span class="o">=</span><span class="n">RunConfig</span><span class="p">(</span><span class="n">company_op</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">yield</span> <span class="n">RunRequest</span><span class="p">(</span>
        <span class="n">job_name</span><span class="o">=</span><span class="s2">&quot;ingest_people_from_signals&quot;</span><span class="p">,</span>
        <span class="n">run_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">run_config</span><span class="o">=</span><span class="n">RunConfig</span><span class="p">(</span><span class="n">people_op</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div>
<p><strong>Behavior:</strong></p>
<ul>
<li><strong>Trigger condition</strong>: <code>ingest_signals_from_accern</code> completes with SUCCESS status</li>
<li><strong>Actions</strong>: Issues two <code>RunRequest</code> objects to launch downstream jobs</li>
<li><strong>Configuration injection</strong>: Passes <code>source_name="Accern"</code> and appropriate watchlist config to each job</li>
<li><strong>Minimum interval</strong>: Won't re-trigger within 2 hours (prevents accidental cascades)</li>
</ul>
<p><strong>Why Sensors Instead of Dependencies?</strong></p>
<p>Sensors provide loose coupling:</p>
<ul>
<li>Signal ingestion jobs can run independently (easier testing, manual re-runs)</li>
<li>Entity extraction can process signals from multiple sources (Accern, Gmail) using the same job definition</li>
<li>Failure in one source doesn't block another</li>
</ul>
<p><strong>Monitoring:</strong></p>
<p>Sensors appear in the Dagster UI's "Sensors" tab, showing:</p>
<ul>
<li>Last tick time</li>
<li>Trigger count</li>
<li>Requested runs</li>
</ul>
<hr />
<h2 id="35-entity-extraction-jobs">3.5 Entity Extraction Jobs<a class="headerlink" href="#35-entity-extraction-jobs" title="Permanent link">&para;</a></h2>
<p>These jobs process signals to extract, enrich, and store companies and people.</p>
<h3 id="351-ingest_companies_from_signals">3.5.1 ingest_companies_from_signals<a class="headerlink" href="#351-ingest_companies_from_signals" title="Permanent link">&para;</a></h3>
<p><strong>Purpose:</strong> Extract companies from signals, enrich via Harmonic, filter, and store.</p>
<p><strong>Op Sequence:</strong></p>
<ol>
<li><code>fetch_source_from_db(source_name)</code> → Returns <code>DataSourceReturn</code></li>
<li><code>get_source_watchlist(source_name)</code> → Returns <code>Watchlist</code></li>
<li>Fetches "DealFlow - {source_name}" watchlist from Harmonic</li>
<li><code>get_all_signals_from_source(source)</code> → Returns <code>list[SignalWithTags]</code></li>
<li>Queries signals where <code>source_id</code> matches and <code>source_company_ids IS NULL</code></li>
<li><code>search_companies_with_harmonic(signals)</code> → Returns <code>dict[str, Optional[CompanyBase]]</code></li>
<li>Extracts unique company names from <code>SignalWithTags.ner_tags.org</code></li>
<li>Calls <code>harmonic.search_and_match_company(name)</code> for each</li>
<li><code>parse_matched_companies(signals, search_results)</code> → Returns <code>(list[SignalWithCompanies], list[SignalWithCompanies])</code></li>
<li><strong>companies_to_insert</strong>: Exact name match found from search, AND the NER tag has no URL</li>
<li><strong>companies_to_enrich</strong>: Have URLs, OR not found by name search</li>
<li><code>enrich_companies_with_harmonic(companies_to_enrich)</code> → Returns <code>list[SignalWithCompanies]</code></li>
<li>Calls <code>harmonic.enrich_company("website_url", url)</code> for each</li>
<li>Marks as "unknown" if enrichment fails</li>
<li><code>filter_companies(searched, enriched)</code> → Returns <code>(list[CompanyWithSignalId], list[SignalWithCompanyIds])</code></li>
<li>Applies location, stage, funding, headcount, investor filters</li>
<li><code>update_signals_in_db(updated_signals)</code> → Updates <code>Signal.source_company_ids</code></li>
<li><code>store_companies_from_signals_in_db(filtered)</code> → Inserts <code>Company</code> records</li>
<li><code>store_companies_metrics_from_signals_in_db(filtered, inserted)</code> → Inserts <code>CompanyMetric</code> records</li>
<li><code>add_to_watchlist(watchlist, filtered)</code> → Adds companies to Harmonic watchlist</li>
</ol>
<p><strong>Critical Logic:</strong></p>
<ul>
<li><strong>Two-phase enrichment</strong>: Name search (fallback) → URL enrichment (main)</li>
<li><strong>Filtering</strong>:</li>
<li>Location: <code>company.location.country IN LOCATION_FILTER_LIST</code></li>
<li>Stage: <code>company.stage IN FUNDING_ROUND_FILTER_LIST</code></li>
<li>Funding: <code>company.funding.funding_total &lt; 15_000_000</code></li>
<li>Headcount: <code>company.headcount &lt;= 75</code></li>
<li>Investor: <code>company.investor_urn IS NULL</code></li>
<li><strong>Signal update</strong>: Links signals to final company IDs for traceability</li>
</ul>
<p><strong>ECS Configuration:</strong></p>
<p>This job has custom resource limits:
<div class="highlight"><pre><span></span><code><span class="nd">@job</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ecs/cpu&quot;</span><span class="p">:</span> <span class="s2">&quot;1024&quot;</span><span class="p">,</span> <span class="s2">&quot;ecs/memory&quot;</span><span class="p">:</span> <span class="s2">&quot;6144&quot;</span><span class="p">})</span>
</code></pre></div>
Allocates 1 vCPU and 6 GB RAM (higher than default) due to:
- Large Harmonic API response payloads
- Concurrent enrichment of multiple companies
- In-memory deduplication of entities</p>
<h3 id="352-ingest_people_from_signals">3.5.2 ingest_people_from_signals<a class="headerlink" href="#352-ingest_people_from_signals" title="Permanent link">&para;</a></h3>
<p><strong>Purpose:</strong> Extract people from signals, enrich via Harmonic, and store.</p>
<p><strong>Op Sequence:</strong></p>
<p>Mirrors <code>ingest_companies_from_signals</code> with people-specific logic:</p>
<ol>
<li><code>fetch_source_from_db(source_name)</code></li>
<li><code>get_source_people_watchlist(source_name)</code> → Returns <code>PeopleWatchlist</code></li>
<li><code>get_empty_signals_from_source(source)</code> → Returns <code>list[SignalWithTags]</code></li>
<li>Queries signals where <code>source_people_ids IS NULL</code></li>
<li><code>enrich_people_with_harmonic(signals)</code> → Returns <code>list[SignalWithPeople]</code></li>
<li>Calls <code>harmonic.enrich_people("linkedin_url", url)</code> for each person</li>
<li><code>filter_people(enriched)</code> → Returns <code>(list[SignalWithFilteredPeople], list[SignalWithPeopleIds])</code></li>
<li>Currently no filtering logic (placeholder for future criteria)</li>
<li><code>update_signals_with_people_ids(updated_signals)</code></li>
<li><code>add_to_source_people_watchlist(watchlist, signals)</code></li>
<li><code>store_people_from_signals_in_db(filtered)</code> → Inserts <code>Person</code> records</li>
</ol>
<p><strong>Differences from Companies:</strong></p>
<ul>
<li>No URL discovery (LinkedIn URLs come from entity context extraction)</li>
<li>No filtering criteria (all enriched people are stored)</li>
<li>Simpler flow due to fewer data quality issues</li>
</ul>
<h3 id="353-ingest_companies_from_searches">3.5.3 ingest_companies_from_searches<a class="headerlink" href="#353-ingest_companies_from_searches" title="Permanent link">&para;</a></h3>
<p><strong>Purpose:</strong> Ingest companies from Harmonic saved searches, store, and add to watchlist.</p>
<p><strong>Op Sequence:</strong></p>
<ol>
<li><code>fetch_source_from_db(source_name="Harmonic Search")</code></li>
<li><code>get_source_watchlist(source_name)</code> → Returns <code>Watchlist</code></li>
<li><code>get_saved_searches_from_harmonic()</code> → Returns <code>list[SearchList]</code></li>
<li>Fetches searches prefixed with "DealFlow" (excluding filter list)</li>
<li><code>get_companies_from_search(searches)</code> → Returns <code>list[SearchWithCompanies]</code></li>
<li>Calls <code>harmonic.get_companies_by_search(search_id)</code> for each</li>
<li><code>parse_searches_for_watchlist(searches)</code> → Returns <code>(list[str], list[SearchWithCompanyIds], list[CompanyBase])</code></li>
<li>Extracts company URNs, IDs, and full objects</li>
<li><code>add_to_harmonic_watchlist(watchlist, urns)</code></li>
<li><code>store_harmonic_search_in_db(source, searches)</code> → Inserts <code>Search</code> records</li>
<li><code>store_harmonic_companies_in_db(searches, inserted_searches)</code> → Inserts <code>Company</code> records</li>
<li><code>store_company_metrics_in_db(inserted, all)</code> → Inserts <code>CompanyMetric</code> records</li>
</ol>
<p><strong>Key Logic:</strong></p>
<ul>
<li><strong>Net new results</strong>: Harmonic searches are configured to return only new companies since last fetch</li>
<li><strong>No filtering</strong>: Companies from searches bypass OMVision's filters (assumed pre-filtered by search criteria)</li>
<li><strong>Direct enrichment</strong>: Companies arrive with full Harmonic data; no URL discovery or enrichment needed</li>
</ul>
<h3 id="354-ingest_people_from_searches">3.5.4 ingest_people_from_searches<a class="headerlink" href="#354-ingest_people_from_searches" title="Permanent link">&para;</a></h3>
<p><strong>Purpose:</strong> Ingest people from Harmonic saved searches and store.</p>
<p><strong>Op Sequence:</strong></p>
<p>Mirrors <code>ingest_companies_from_searches</code> for people:</p>
<ol>
<li><code>fetch_source_from_db(source_name="Harmonic Search")</code></li>
<li><code>get_source_people_watchlist(source_name)</code> → Returns <code>PeopleWatchlist</code></li>
<li><code>get_saved_people_searches_from_harmonic()</code> → Returns <code>list[SearchList]</code></li>
<li><code>get_people_from_search(searches)</code> → Returns <code>list[SearchWithPeople]</code></li>
<li><code>parse_searches_for_people_watchlist(searches)</code> → Returns <code>(list[str], list[SearchWithPeopleIds], list[PeopleBase])</code></li>
<li><code>add_to_harmonic_people_watchlist(watchlist, urns)</code></li>
<li><code>store_people_search_in_db(source, searches)</code> → Inserts <code>Search</code> records</li>
<li><code>store_harmonic_people_in_db(searches, inserted_searches)</code> → Inserts <code>Person</code> records</li>
</ol>
<hr />
<h2 id="36-classification-job">3.6 Classification Job<a class="headerlink" href="#36-classification-job" title="Permanent link">&para;</a></h2>
<p><strong>Job:</strong> <code>classify_ingested_companies</code></p>
<p><strong>Purpose:</strong> Apply machine learning models to assign relevance ranks (0-4) to unclassified companies.</p>
<p><strong>Op Sequence:</strong></p>
<ol>
<li><code>get_all_unclassified_companies()</code> → Returns <code>(pd.DataFrame, pd.DataFrame)</code></li>
<li><strong>nl_features</strong>: Description, highlights, employee_highlights, traction_metrics</li>
<li>
<p><strong>other_features</strong>: Headcount, funding, stage, location, founding_date, etc.</p>
</li>
<li>
<p><code>format_company_nl_features(nl_features)</code> → Returns <code>list[CompanyNLFeaturesFormatted]</code></p>
</li>
<li>
<p>Structures NL fields into consistent schema</p>
</li>
<li>
<p><code>extract_numerical_features_from_nl(formatted)</code> → Returns <code>list[CompanyExtractedRatingFeatures]</code></p>
</li>
<li>Calls OpenAI API with:<ul>
<li><strong>System message</strong>: Defines input features and output ratings (0.0-1.0)</li>
<li><strong>User message</strong>: Provides company NL features</li>
</ul>
</li>
<li>
<p>Returns ratings: product_maturity, market_opportunity, founder_strength, technology_moat, traction_growth</p>
</li>
<li>
<p><code>prepare_input_dataframe(extracted, other_features)</code> → Returns <code>pd.DataFrame</code></p>
</li>
<li>Merges NL ratings with other features</li>
<li>
<p>Creates unified feature set</p>
</li>
<li>
<p><code>preprocess_input_features(df)</code> → Returns <code>(pd.DataFrame, pd.DataFrame)</code></p>
</li>
<li><strong>Date conversions</strong>: Converts dates to timestamps, calculates age/recency</li>
<li><strong>Categorical encoding</strong>: Maps funding type, stage to integers; label-encodes country</li>
<li><strong>Feature scaling</strong>: Applies MinMaxScaler to numerical columns</li>
<li>
<p><strong>Splits</strong>:</p>
<ul>
<li><strong>primary_df</strong>: Complete data (no NaN)</li>
<li><strong>secondary_df</strong>: Incomplete data (has NaN)</li>
</ul>
</li>
<li>
<p><code>get_primary_company_classes(primary_df)</code> → Returns <code>list[CompanyClassification]</code></p>
</li>
<li>Loads <code>lightgbm_model.pkl</code></li>
<li>
<p>Predicts ranks using all features</p>
</li>
<li>
<p><code>update_company_classes_in_db(primary_classifications)</code></p>
</li>
<li>
<p>Bulk updates <code>Company.rank</code></p>
</li>
<li>
<p><code>get_secondary_company_classes(secondary_df)</code> → Returns <code>list[CompanyClassification]</code></p>
</li>
<li>Loads <code>lightgbm_nan_model.pkl</code></li>
<li>
<p>Predicts ranks using NL features only</p>
</li>
<li>
<p><code>update_company_classes_in_db(secondary_classifications)</code></p>
</li>
</ol>
<p><strong>Model Details:</strong></p>
<ul>
<li><strong>Algorithm</strong>: LightGBM with ordinal classification wrapper</li>
<li><strong>Ordinal classes</strong>: 0 (lowest relevance) to 4 (highest relevance)</li>
<li><strong>Training data</strong>: Historical companies with manual rank assignments from users</li>
<li><strong>Features</strong>:</li>
<li><strong>Numerical</strong>: Headcount, funding amount, company age, time since funding</li>
<li><strong>Categorical</strong>: Stage, funding type, location</li>
<li><strong>NL-derived</strong>: Product maturity, market opportunity, founder strength, tech moat, traction</li>
<li><strong>Evaluation metric</strong>: Accuracy (correct rank prediction)</li>
</ul>
<p><strong>Why OpenAI for Feature Extraction?</strong></p>
<p>Traditional feature engineering struggles to quantify qualitative descriptions. OpenAI's language models excel at semantic understanding and can reliably score companies based on textual descriptions, providing features unavailable from structured data alone.</p>
<p><strong>Why Two Models?</strong></p>
<ul>
<li><strong>Primary</strong>: Maximizes accuracy when all data available</li>
<li><strong>Secondary</strong>: Ensures no company is left unclassified due to missing data</li>
</ul>
<hr />
<h2 id="37-data-persistence-jobs">3.7 Data Persistence Jobs<a class="headerlink" href="#37-data-persistence-jobs" title="Permanent link">&para;</a></h2>
<h3 id="371-persist_custom_columns_data">3.7.1 persist_custom_columns_data<a class="headerlink" href="#371-persist_custom_columns_data" title="Permanent link">&para;</a></h3>
<p><strong>Purpose:</strong> Sync user-generated metadata from frontend to backend.</p>
<p><strong>Op Sequence:</strong></p>
<p><strong>For Companies:</strong></p>
<ol>
<li><code>get_companies_to_harmonise()</code> → Returns <code>list[CompanyCustomColumns]</code></li>
<li>
<p>Fetches companies created today</p>
</li>
<li>
<p><code>get_custom_columns_data(ingested)</code> → Returns <code>(list[CompanyCustomColumns], list[CompanyCustomColumns])</code></p>
</li>
<li>Queries frontend DB by <code>(name, source_company_id)</code></li>
<li>
<p>Returns:</p>
<ul>
<li><strong>custom_columns</strong>: Scalar metadata (relevence_stage, comments, is_hidden)</li>
<li><strong>lists</strong>: List associations (list_ids)</li>
</ul>
</li>
<li>
<p><code>update_custom_columns(ingested, custom_columns)</code></p>
</li>
<li>Matches ingested companies to frontend data</li>
<li>
<p>Bulk updates backend <code>Company</code> records</p>
</li>
<li>
<p><code>update_lists(ingested, lists)</code></p>
</li>
<li>Updates <code>ListEntityAssociation</code> mappings</li>
</ol>
<p><strong>For People:</strong></p>
<ol>
<li><code>get_people_to_harmonise()</code> → Returns <code>list[PersonCustomColumns]</code></li>
<li><code>get_custom_columns_data_for_people(ingested)</code></li>
<li><code>update_custom_columns_for_people(ingested, custom_columns)</code></li>
<li><code>update_lists_for_people(ingested, lists)</code></li>
</ol>
<p><strong>Data Sync Direction:</strong></p>
<p>Frontend → Backend (unidirectional)</p>
<p><strong>Rationale:</strong></p>
<p>The frontend serves as the "source of truth" for user interactions. The backend must reflect these interactions to:</p>
<ul>
<li>Enable accurate ML training (user feedback as labels)</li>
<li>Maintain data consistency across systems</li>
<li>Support analytics on user behavior</li>
</ul>
<h3 id="372-upsert_data_sources">3.7.2 upsert_data_sources<a class="headerlink" href="#372-upsert_data_sources" title="Permanent link">&para;</a></h3>
<p><strong>Purpose:</strong> Initialize or update data source configurations.</p>
<p><strong>Op Sequence:</strong></p>
<ol>
<li><code>get_default_sources()</code> → Returns <code>list[DataSourceBase]</code></li>
<li>
<p>Loads default sources from <code>app/constants/data_sources.py</code></p>
</li>
<li>
<p><code>upsert_sources_in_db(default_sources)</code> → Inserts/updates <code>Source</code> records</p>
</li>
<li>Uses <code>db.bulk_insert_rows</code> with upsert semantics</li>
<li>Updates <code>name</code>, <code>description</code>, <code>base_url</code>, <code>channels</code></li>
</ol>
<p><strong>Usage:</strong></p>
<p>This job typically runs once during initial setup or after modifying source configurations. It ensures the database has the latest source metadata, which other jobs reference via <code>fetch_source_from_db</code>.</p>
<p><strong>Default Sources:</strong></p>
<ul>
<li><strong>Accern</strong>: Three channels (venture deal flow, Fund I tracking, Fund II tracking)</li>
<li><strong>Gmail</strong>: Newsletter monitoring account</li>
<li><strong>Harmonic Search</strong>: API for saved searches</li>
</ul>
<hr />
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h2>
<p>OMVision's data pipeline orchestrates a complex workflow transforming raw signals into actionable investment opportunities. The pipeline's design emphasizes:</p>
<ul>
<li><strong>Modularity</strong>: Each job has a single responsibility, enabling independent testing and maintenance</li>
<li><strong>Scalability</strong>: Dagster's ECS integration allows horizontal scaling; resource-intensive jobs (entity extraction, enrichment) allocate additional CPU/memory</li>
<li><strong>Observability</strong>: Centralized logging, run history, and sensor monitoring provide visibility into pipeline health</li>
<li><strong>Extensibility</strong>: Adding new data sources requires defining new jobs and sensors, but doesn't necessitate modifying existing logic</li>
</ul>
<p>The combination of Dagster orchestration, OpenAI-powered NER, Harmonic enrichment, and ML classification creates a robust, automated deal sourcing engine that processes thousands of signals daily while surfacing only the most relevant early-stage companies for manual review.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.expand", "navigation.sections", "navigation.top", "toc.integrate", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
      
        <script src="../../javascripts/mermaid-init.js"></script>
      
    
  </body>
</html>